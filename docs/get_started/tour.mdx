---
id: tour
[//]: # (sidebar_position: 3 --> this is now set by sidebars.js)
title: "Tour of Restate"
description: "Discover Restate using the TypeScript handler API."
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';
import Step from "../../src/components/Stepper";

# Tour of Restate


<Tabs groupId="sdk" queryString>
<TabItem value="ts" label="TypeScript">
</TabItem>
<TabItem value="java" label="Java">
</TabItem>
</Tabs>

This tutorial guides you through the development of an end-to-end Restate application, and covers all the essential features.
After this tutorial, you should have a firm understanding of how Restate can help you and feel comfortable to tackle your next application on your own.

This tutorial implements a ticket reservation application for a theatre.
It allows users to add tickets for specific seats to their shopping cart.
After the user adds a ticket, the seat gets reserved for 15 minutes.
If the user doesn't pay for the ticket within that time interval, the reservation is released and the ticket becomes available to other users.

Restate applications are made up of services that expose handlers to each other and the outside world.
Services communicate with one another using Remote Procedure Calls (RPC).
Our ticket example consists of three services having the following responsibilities:

1. **CartObject**: tracks the tickets in the shopping cart.
2. **TicketObject**: manages the ticket allocation.
3. **CheckoutService**: handles the checkout process of the ticket sale.

![Tour of Restate diagram](/img/tour.svg)

As we go, you will discover how Restate can help you with some intricacies in this application.

<Admonition type="note" title="Prerequisites">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

- Latest stable version of [NodeJS](https://nodejs.org/en/) >= v18.17.1 and [npm CLI](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) >= 9.6.7 installed.
- [Docker Engine](https://docs.docker.com/engine/install/) or [Podman](https://podman.io/docs/installation) to launch the Restate runtime (not needed for the app implementation itself).
- [curl](https://everything.curl.dev/get)

This guide is written for:
- TypeScript SDK version: `@restatedev/restate-sdk:VAR::TYPESCRIPT_SDK_VERSION`
- Restate runtime Docker image: `docker.io/restatedev/restate:VAR::RESTATE_VERSION`

</TabItem>
<TabItem value="java" label="Java">
- JDK >= 11
- [Docker Engine](https://docs.docker.com/engine/install/) or [Podman](https://podman.io/docs/installation) to launch the Restate runtime (not needed for the app implementation itself).
- [curl](https://everything.curl.dev/get)

This guide is written for:
- Java SDK version: `dev.restate:sdk-api:VAR::JAVA_SDK_VERSION`
- Restate runtime Docker image: `docker.io/restatedev/restate:VAR::RESTATE_VERSION`

</TabItem>
</Tabs>
</Admonition>

## Getting started

<Step stepLabel="1" title="Setting up the tutorial">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

Download the [tutorial](https://github.com/restatedev/examples/tree/main/tutorials/tour-of-restate-java):

<Tabs groupId="download">
<TabItem value="cli" label="CLI">

```shell
restate example typescript-tour-of-restate && cd typescript-tour-of-restate
```

</TabItem>
<TabItem value="git" label="git clone">

```shell
git clone git@github.com:restatedev/examples.git
cd examples/tutorials/tour-of-restate-typescript
```

</TabItem>
<TabItem value="wget" label="wget">

```shell
wget https://github.com/restatedev/examples/releases/latest/download/typescript-tour-of-restate.zip && unzip typescript-tour-of-restate.zip -d typescript-tour-of-restate && rm typescript-tour-of-restate.zip
```

</TabItem>
</Tabs>

This GitHub repository contains the basic skeleton of the NodeJS/TypeScript services that you develop in this tutorial.

First, get all dependencies and build tools. Then build the app:
```shell
npm install && npm run build
```

</TabItem>
<TabItem value="java" label="Java">

Download the [tutorial](https://github.com/restatedev/examples/tree/main/tutorials/tour-of-restate-typescript):

<CH.Code>
```shell CLI
restate example java-tour-of-restate && cd java-tour-of-restate
```

```shell wget
wget https://github.com/restatedev/examples/releases/latest/download/java-tour-of-restate.zip &&
    unzip java-tour-of-restate.zip -d java-tour-of-restate &&
    rm java-tour-of-restate.zip && cd java-tour-of-restate
```
</CH.Code>

This GitHub repository contains the basic skeleton of the Java services that you develop in this tutorial.

</TabItem>
</Tabs>
</Step>

<Step stepLabel="2" title="Running the services">

Let's run the services that we will be implementing. For now, the handlers are empty placeholders.

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run app
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew run
```

</TabItem>
</Tabs>

</Step>

<Step stepLabel="3" title="Launch Restate">
Restate runs as a single standalone binary.
Launch Restate in your preferred way:

<CH.Code rows={"2"}>

    ```shell npx
    npx @restatedev/restate-server
    ```

    ``` shell Homebrew
    brew install restatedev/tap/restate-server && restate-server
    ```

    ```shell Docker
    docker run --name restate_dev --rm -p 8080:8080 -p 9070:9070 -p 9071:9071 \
        --add-host=host.docker.internal:host-gateway docker.io/restatedev/restate:VAR::RESTATE_VERSION
    ```

</CH.Code>

<Admonition type="tip" icon="üí°" title="Single binary">
    Restate is a single self-contained binary. No external dependencies needed. Check out our [download page](https://restate.dev/get-restate/) for other ways to run Restate.
</Admonition>

When you stop the container, any persisted state is dropped because we start the container with the `--rm` flag.
</Step>

<Step stepLabel="4" title="Registering services with Restate">

Now, we need to tell Restate where our services are running.
You can register services by calling the Restate Admin API (default port `9070`) and supplying it the service endpoint URI:

<CH.Code rows={"2"}>

    ```shell CLI
    restate dp reg http://localhost:9080
    ```

    ```shell curl
    curl localhost:9070/deployments -H 'content-type: application/json' \
        -d '{"uri": "http://localhost:9080"}'
    ```

</CH.Code>
<details className="grey-details">
    <summary>Output</summary>

    <Tabs groupId="sdk" queryString className={"display-none"}>
        <TabItem value="ts" label="TypeScript">

            ```json
            {
                "id": "bG9jYWxob3N0OjgwODAv",
                "services": [
            {
                "name": "TicketObject",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            },
            {
                "name": "CartObject",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            },
            {
                "name": "CheckoutService",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            }
                ]
            }
            ```

        </TabItem>
        <TabItem value="java" label="Java">

            ```json
            {
                "id": "bG9jYWxob3N0OjgwODAv",
                "services": [
            {
                "name": "TicketObject",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            },
            {
                "name": "CartObject",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            },
            {
                "name": "CheckoutService",
                "revision": 1
                /* ... Additional information on registered methods ...*/
            }
                ]
            }
            ```

        </TabItem>
    </Tabs>

</details>

If you run Restate with Docker, replace `http://host.docker.internal:9080` by `http://localhost:9080`.

Once registered, Restate knows which services run behind the endpoint and can invoke them.
</Step>

<Step stepLabel="üèÅ" title="All set up!">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">
In `src/app` you will find the skeletons of the various services to help you start implementing the app.
    The `app.ts` file contains the definition of the endpoint that hosts the services.
</TabItem>
<TabItem value="java" label="Java">
In `src/main/java/dev/restate/tour/app` you will find the skeletons of the various services to help you start implementing the app.
For example:
```java CheckoutService.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CheckoutService.java#<start_service>-<end_service>
```

Services are annotated by `@Service`. A service consists of a set of handlers, and each handler is annotated by `@Handler`.

The `AppMain.java` file contains the definition of the endpoint that hosts the services.
</TabItem>
</Tabs>
</Step>

## Invoking handlers
<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part1"/>

Handlers can be invoked in several ways: via HTTP requests, programmatically with the SDK, or via Kafka events.

### Invoking handlers via HTTP requests
Let's start with invoking our handler over HTTP using `curl`.
For example, add a ticket `456` to Mary's cart by calling the `addTicket` handler of the `CartObject`:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
curl localhost:8080/CartObject/addTicket \
    -H 'content-type: application/json' \
    -d '{"key": "Mary", "request": "456"}'
```

</TabItem>
<TabItem value="java" label="Java">

```shell
curl localhost:8080/CartObject/Mary/addTicket -d '456'
```

</TabItem>
</Tabs>

If this prints out `true`, then you have a working setup.

As you see, the request is sent to Restate and not directly to the service.
This is because Restate will first make sure that the request is persisted and will then forward it to the service.
Once the request has been persisted, it will never get lost and Restate will drive the execution of the handler to completion.

To let Mary proceed with the purchase, call the `checkout` handler of the `CartObject`:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
curl localhost:8080/CartObject/checkout \
    -H 'content-type: application/json' \
    -d '{"key": "Mary"}'
```

</TabItem>
<TabItem value="java" label="Java">

```shell
curl localhost:8080/CartObject/Mary/checkout
```

</TabItem>
</Tabs>

We will use these two `curl` commands often when developing the code, so keep them handy.

### Sending messages

As you noticed, the `curl` command returned the response of the handler.
The request we did was a request-response call, where we waited for the response.
You can call without waiting for the response, similar to sending a message to a queue:

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```shell
        curl localhost:8080/CartObject/addTicket \
        -H 'content-type: application/json' \
        -d '{"key": "Mary", "request": "456"}'
        ```

    </TabItem>
    <TabItem value="java" label="Java">

        ```shell
        curl localhost:8080/CartObject/Mary/addTicket/send -d '456'
        ```

    </TabItem>
</Tabs>

We can do the same programmatically within a handler by using the SDK.

In the example, when a seat gets added to the shopping cart, it gets reserved for 15 minutes.
When a user didn't proceed with the payment before the timeout, the `CartObject/expireTicket` handler is triggered.
Let the `expireTicket` handler call the `TicketObject/unreserve` handler.

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript ticket_service.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/user_session.ts#<start_expire_ticket>-<end_expire_ticket>
```

Specify that you want to call the `TicketObject` by supplying `ticketObjectApi` to the `send` function.
Then call the `unreserve` function on the `TicketObject`.

Once you have added this to the code, try it out by calling the `CartObject/expireTicket` function:

```shell
curl localhost:8080/CartObject/Mary/expireTicket -d '456'
```

In the service logs, you see that the `expireTicket` function gets executed,
after which the `unreserve` function gets executed.
The call to `expireTicket` finishes earlier than the `unreserve` function because it didn't wait for the response of the `unreserve` function.

<details className="grey-details">
<summary>Show the logs</summary>

```log
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.671Z] DEBUG: Invoking function.
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.672Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.673Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
// withClass highlight-line
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.673Z] DEBUG: Function completed successfully.
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Invoking function.
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
// withClass highlight-line
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Function completed successfully.
```

</details>


</TabItem>
<TabItem value="java" label="Java">

```java CartObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_expire_ticket>-<end_expire_ticket>
```
To do a call with the SDK from within a Restate handler:
- **Use the pre-generated client**: This gets generated when you compile the code for the first time.
    So if you haven't done that yet, run `./gradlew build` to generate the client.
- **Supply the context** via `fromContext(ctx)`
- **Call `send()` on the client**: to specify that you want to send a message without caring about the response.
- **Specify the handler** you want to call and supply the request.

Try it out by running the services via `./gradlew run` and send a request to `example.CartObject/ExpireTicket`.

Call the `expireTicket` function with:
```shell
curl localhost:8080/CartObject/Mary/expireTicket -d '456'
```
<details>
    <summary>Service logs</summary>

    ```log
    // withClass highlight-line
    2024-03-19 11:59:52 DEBUG [example.CartObject/ExpireTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/ExpireTicket
    2024-03-19 11:59:52 INFO  [example.CartObject/ExpireTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
    2024-03-19 11:59:52 DEBUG [example.CartObject/ExpireTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr} to REPLAYING
    2024-03-19 11:59:52 DEBUG [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr} to PROCESSING
    2024-03-19 11:59:52 INFO  [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr] dev.restate.sdk.core.InvocationStateMachine - End invocation
    2024-03-19 11:59:52 DEBUG [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr} to CLOSED
    // withClass highlight-line
    2024-03-19 11:59:52 INFO  [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM960tknAyE5cVaOY7BxBN7Lr] dev.restate.sdk.core.InvocationStateMachine - End invocation
    // withClass highlight-line
    2024-03-19 11:59:52 DEBUG [example.TicketObject/Unreserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Unreserve
    2024-03-19 11:59:52 INFO  [example.TicketObject/Unreserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
    2024-03-19 11:59:52 DEBUG [example.TicketObject/Unreserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj} to REPLAYING
    2024-03-19 11:59:52 DEBUG [example.TicketObject/Unreserve][inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj} to PROCESSING
    2024-03-19 11:59:52 INFO  [example.TicketObject/Unreserve][inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj] dev.restate.sdk.core.InvocationStateMachine - End invocation
    2024-03-19 11:59:52 DEBUG [example.TicketObject/Unreserve][inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj} to CLOSED
    2024-03-19 11:59:52 INFO  [example.TicketObject/Unreserve][inv_1k78Krj3GqrK2YdHl3yeF9fGJgycRHIalj] dev.restate.sdk.core.InvocationStateMachine - End invocation
    ```

</details>

In the service logs, you see that the `expireTicket` function gets executed, after which the `unreserve` function gets executed.
The call to `expireTicket` finishes earlier than the `unreserve` function because `expireTicket` didn't wait for the response of the `unreserve` function.



</TabItem>
</Tabs>

<Admonition type="tip" title="Restate as your message queue">
Restate persists and retries failed one-way invocations. There is no need to set up message queues to ensure delivery!
</Admonition>


### Calling services within Restate

In the previous section, we covered sending messages to other services, without waiting for a response.
With Restate, you can also make request-response calls (RPCs) where you do wait for the response.

When the `CartObject/addTicket` function is called, it first needs to reserve the ticket for the user.
It does that by calling the `TicketObject/reserve` function.
Add the highlighted code snippet to the `addTicket` function in the `CartObject` service.

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/user_session.ts#<start_add_ticket>-<end_add_ticket>
```

You do the call via `ctx.rpc` and supply the exported `ticketObjectApi` to specify which service to invoke.
Then you call the `reserve` function, which returns a Promise that will get resolved with the `boolean` response.

Run the services via `npm run app` and send a request to `CartObject/addTicket`, as we did [previously](#calling-services-from-outside-restate).

In the service logs, you see that the `addTicket` function gets executed,
after which the `reserve` function gets executed.
The call to `addTicket` finishes earlier than the `reserve` function because it didn't wait for the response of the `reserve` function.

<details>
<summary>Show the logs</summary>

```log
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.790Z] DEBUG: Invoking function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.792Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.792Z] DEBUG: Scheduling suspension in 30000 ms
// withClass highlight-line
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Invoking function.
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
// withClass highlight-line
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Function completed successfully.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.799Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.800Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.800Z] DEBUG: Function completed successfully.
```

</details>

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_add_ticket>-<end_add_ticket>
```

There are two differences with one-way calls: you don't call `oneWay()` on the client, and you use `.await()` to wait for the response to the call.
Once you have added this to the code, restart the service and try it out by calling the `CartObject/addTicket` method as [explained earlier](#calling-services-from-outside-restate).

<details>
<summary>Show the logs</summary>

```log
// withClass highlight-line
2024-03-19 12:04:34 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/AddTicket
2024-03-19 12:04:34 INFO  [example.CartObject/AddTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 12:04:34 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd} to REPLAYING
2024-03-19 12:04:34 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd} to PROCESSING
// withClass highlight-line
2024-03-19 12:04:34 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Reserve
2024-03-19 12:04:34 INFO  [example.TicketObject/Reserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 12:04:34 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn} to REPLAYING
2024-03-19 12:04:34 DEBUG [example.TicketObject/Reserve][inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn} to PROCESSING
2024-03-19 12:04:34 INFO  [example.TicketObject/Reserve][inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:04:34 DEBUG [example.TicketObject/Reserve][inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn} to CLOSED
2024-03-19 12:04:34 INFO  [example.TicketObject/Reserve][inv_1k78Krj3GqrK5GMKJrWA38xZeWVVPcAkjn] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:04:34 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:04:34 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd} to CLOSED
2024-03-19 12:04:34 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM97rgki7ACX0CO83BJ7lkPQd] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</details>
</TabItem>
</Tabs>

## Durable Execution

The call you just added seems like a regular RPC call as you might know them from other service frameworks. This similarity is superficial; under the hood the Restate runtime and SDK cooperate to deliver resiliency and efficiency.

When an incoming request is sent to Restate, the runtime first persists it. It establishes a connection to the `CartObject`, and sends the request over to begin a new invocation. All communications between the service and other Restate components goes over this connection.

When the `CartObject` makes an RPC to the `TicketObject`, this request goes over the open connection to the runtime. Once again, this is durably persisted in the Restate journal, before it is passed on (by Restate) to the `TicketObject`. In case of failures, Restate takes care of retries. When the `TicketObject` responds, its response is then sent back to the runtime, which persists it and forwards it to the `CartObject` to continue execution.

When services take a while to respond, Restate suspends the calling execution to free up the resources for other invocations. When the calling service is unblocked to resume, Restate invokes it again and sends over a replay log. This replay log contains all the state that the previously completed steps generated prior to suspension. The service replays the log, and the service resumes execution from the point where it left off prior to suspending.

<Admonition type="tip">
The suspension mechanism is especially beneficial if you deploy your services to a FaaS platform such as AWS Lambda. This way you don't pay for the idle time a caller spends waiting for a response when making synchronous service calls within Restate!
</Admonition>

### Recovery of partial progress

To see this work in practice, let's pretend that ticket reservations take a while by making the `TicketObject/reserve` function sleep for a while.

<Admonition type="caution">
This is not the best way to sleep in a Restate service! The Restate SDK offers a native way to suspend execution for a period of time. We will cover [suspendable sleep later on](#suspendable-sleep).
</Admonition>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">
Add the import:
```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/ticket_service.ts#<start_import_sleep>-<end_import_sleep>
```

Add the sleep:
```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/ticket_service.ts#<start_reserve>-<end_reserve>
```

Call `CartObject/addTicket` again and have a look at the SDK logs.
Now that the `TicketObject` responds after 35 seconds, you see that the `addTicket` function suspends after 30 seconds.
Once the runtime has received the response, it invokes the `addTicket` function again and the original call finishes.
<details>
<summary>Show the logs</summary>

```log
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:49:43.849Z] DEBUG: Invoking function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:49:43.850Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:49:43.851Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK4tGbnNcKlrKTRsIDu7R6xz][2024-03-19T07:49:43.855Z] DEBUG: Invoking function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:13.853Z] DEBUG: Writing suspension message to journal. ; SuspensionMessage
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:13.853Z] DEBUG: Suspending function.
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK4tGbnNcKlrKTRsIDu7R6xz][2024-03-19T07:50:18.860Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK4tGbnNcKlrKTRsIDu7R6xz][2024-03-19T07:50:18.861Z] DEBUG: Function completed successfully.
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:18.906Z] DEBUG: Resuming (replaying) function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:18.906Z] DEBUG: Matched and replayed message from journal ; InvokeEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:18.906Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM968NomaJHFQH9MgVlD4B5AZ][2024-03-19T07:50:18.906Z] DEBUG: Function completed successfully.
```

</details>

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/TicketObject.java#<start_reserve>-<end_reserve>
```

Call `CartObject/addTicket` again and have a look at the SDK logs.
Now that the `TicketObject` responds after 65 seconds, you see that the `addTicket` function suspends after 60 seconds.
Once the runtime has received the response, it invokes the `addTicket` function again and the original call finishes.

<details>
<summary>Show the logs</summary>

```log
2024-03-19 12:07:39 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/AddTicket
2024-03-19 12:07:39 INFO  [example.CartObject/AddTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 12:07:39 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to REPLAYING
2024-03-19 12:07:39 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to PROCESSING
2024-03-19 12:07:39 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Reserve
2024-03-19 12:07:39 INFO  [example.TicketObject/Reserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 12:07:39 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1} to REPLAYING
2024-03-19 12:07:39 DEBUG [example.TicketObject/Reserve][inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1} to PROCESSING
// withClass highlight-line
2024-03-19 12:08:39 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - Suspend invocation
2024-03-19 12:08:39 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to CLOSED
2024-03-19 12:08:39 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:08:39 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:08:44 INFO  [example.TicketObject/Reserve][inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:08:44 DEBUG [example.TicketObject/Reserve][inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1} to CLOSED
2024-03-19 12:08:44 INFO  [example.TicketObject/Reserve][inv_1k78Krj3GqrK1Ty3SPdvgWvBUDl47aQIE1] dev.restate.sdk.core.InvocationStateMachine - End invocation
// withClass highlight-line
2024-03-19 12:08:44 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/AddTicket
2024-03-19 12:08:44 INFO  [example.CartObject/AddTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 12:08:44 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to REPLAYING
2024-03-19 12:08:44 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to PROCESSING
2024-03-19 12:08:44 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 12:08:44 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D} to CLOSED
2024-03-19 12:08:44 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM91rhGUuFkUoyrtTyMjaE83D] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</details>
</TabItem>
</Tabs>

<Admonition type="tip" title="Cancelling and killing invocations">
[By default](/operate/configuration/#default-configuration), Restate will keep retrying failed invocations until they succeed. If at any point during testing you create an invocation that you want to permanently terminate, you can cancel ([docs](/operate/invocation#cancel-an-invocation)) or kill ([docs](/operate/invocation#kill-an-invocation)) it its invocation ID.
Each invocation gets an ID assigned by Restate. You can find the ID printed in the service logs.
</Admonition>

[//]: # (TODO include a video demo of knative on minikube to show how containers are spun up and torn down.)

### üìù Try it out

Make the `CartObject/checkout` function call the `CheckoutService/handle` function.

For the request field, you can use a hard-coded string array for now: `["456"]`.
You will fix this later on.

<details>
<summary>Solution</summary>

Add the following code to the `CartObject/checkout` function:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

Import the checkout API:
```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/user_session.ts#<start_checkout_api_import>-<end_checkout_api_import>
```

Then call the `CheckoutService/handle` function:
```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/user_session.ts#<start_checkout>-<end_checkout>
```

Call the `CartObject/checkout` function as you did [earlier](#calling-services-from-outside-restate) and have a look at the logs again to see what happened:

```log
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.018Z] DEBUG: Invoking function.
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.019Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.020Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.023Z] DEBUG: Invoking function.
[restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.024Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.024Z] DEBUG: Function completed successfully.
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.026Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.027Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.027Z] DEBUG: Function completed successfully.
```

Notice that the `CartObject` didn't get suspended because the response came before the suspension timeout hit.

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_checkout>-<end_checkout>
```

Restart the service and call the `CartObject/checkout` function as you did earlier and have a look at the logs again to see what happened.

```log
2024-03-19 13:14:11 DEBUG [example.CartObject/CheckoutService] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/CheckoutService
2024-03-19 13:14:11 INFO  [example.CartObject/CheckoutService] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:14:11 DEBUG [example.CartObject/CheckoutService] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T} to REPLAYING
2024-03-19 13:14:11 DEBUG [example.CartObject/CheckoutService][inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T} to PROCESSING
2024-03-19 13:14:11 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:14:11 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:14:11 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd} to REPLAYING
2024-03-19 13:14:11 DEBUG [example.CheckoutService/Handle][inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd} to PROCESSING
2024-03-19 13:14:11 INFO  [example.CheckoutService/Handle][inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:14:11 DEBUG [example.CheckoutService/Handle][inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=PROCESSING, id=inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd} to CLOSED
2024-03-19 13:14:11 INFO  [example.CheckoutService/Handle][inv_1iFNRdXQWy1x1lK7wTza8Qrat7ynTTLWCd] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:14:11 INFO  [example.CartObject/CheckoutService][inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:14:11 DEBUG [example.CartObject/CheckoutService][inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T} to CLOSED
2024-03-19 13:14:11 INFO  [example.CartObject/CheckoutService][inv_1gdJBtdVEcM95fe6Rp7dfMwH7QKIqASh5T] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>

</details>

<Admonition type="info">
üö© Explore the intermediate solution in `part1`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part1
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part1.AppMain run
```

</TabItem>
</Tabs>
</Admonition>

## Durable timers

<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part2"/>

Restate suspends a function invocation when it waits on external input.
The partial progress of the service invocation is durably stored in the log and can be resumed once the external input has arrived.
Restate offers the same mechanism for timers.

### Suspendable sleep

[Earlier in this tutorial](#waiting-for-slow-services), you saw how Restate caller suspension works when you make an RPC request to another service. We artificially slowed down the target service by using platform-native sleep. Sometimes you intentionally want to suspend execution for a period of time, for example to back off from overloading a dependency or simply you are implementing a long-running business workflow. In those situations you can explicitly suspend execution for arbitrarily long periods of time using the Restate context's `sleep` function. Adapt the `TicketObject/reserve` function to use `ctx.sleep`:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part2/ticket_service.ts#<start_reserve>-<end_reserve>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part2/TicketObject.java#<start_reserve>-<end_reserve>
```

</TabItem>
</Tabs>

Send an `addTicket` request, as [you did earlier](#running-the-services-and-runtime).
Now you see in the logs that both services get suspended.
The `CartObject` gets suspended because it waits for a response from the `reserve` function and the `TicketObject` gets suspended because it waits for the sleep to be completed.
Restate keeps track of how long the service should sleep and then triggers it to resume the invocation.
Finally, you see the responses of both functions coming in.

<details>
<summary>Show the logs</summary>
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:18.538Z] DEBUG: Invoking function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:18.539Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:18.539Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:18.543Z] DEBUG: Invoking function.
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:18.543Z] DEBUG: Adding message to journal and sending to Restate ; SleepEntryMessage
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:18.543Z] DEBUG: Scheduling suspension in 30000 ms
// highlight-start
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:48.568Z] DEBUG: Writing suspension message to journal. ; SuspensionMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:48.568Z] DEBUG: Suspending function.
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:48.569Z] DEBUG: Writing suspension message to journal. ; SuspensionMessage
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:48.569Z] DEBUG: Suspending function.
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:53.554Z] DEBUG: Resuming (replaying) function.
// highlight-end
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:53.554Z] DEBUG: Matched and replayed message from journal ; SleepEntryMessage
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:53.554Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [TicketObject/reserve][inv_1k78Krj3GqrK5VGOBoinuc1fiN1eIwKGWZ][2024-03-19T08:01:53.554Z] DEBUG: Function completed successfully.
// highlight-next-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:53.598Z] DEBUG: Resuming (replaying) function.
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:53.598Z] DEBUG: Matched and replayed message from journal ; InvokeEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:53.598Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM914R2BTwQ8Ioyfjy4ap9PxL][2024-03-19T08:01:53.598Z] DEBUG: Function completed successfully.
```

</TabItem>
<TabItem value="java" label="Java">

```log
// withClass highlight-line
2024-03-19 13:17:31 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/AddTicket
2024-03-19 13:17:31 INFO  [example.CartObject/AddTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:17:31 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to REPLAYING
2024-03-19 13:17:31 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to PROCESSING
// withClass highlight-line
2024-03-19 13:17:31 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Reserve
2024-03-19 13:17:31 INFO  [example.TicketObject/Reserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:17:31 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to REPLAYING
2024-03-19 13:17:31 DEBUG [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to PROCESSING
// withClass highlight-line
2024-03-19 13:18:31 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - Suspend invocation
2024-03-19 13:18:31 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to CLOSED
2024-03-19 13:18:31 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:18:31 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - End invocation
// withClass highlight-line
2024-03-19 13:18:31 INFO  [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - Suspend invocation
2024-03-19 13:18:31 DEBUG [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to CLOSED
2024-03-19 13:18:31 INFO  [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:18:31 INFO  [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - End invocation
// withClass highlight-line
2024-03-19 13:18:36 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Reserve
2024-03-19 13:18:36 INFO  [example.TicketObject/Reserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:18:36 DEBUG [example.TicketObject/Reserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to REPLAYING
2024-03-19 13:18:36 DEBUG [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to PROCESSING
2024-03-19 13:18:36 INFO  [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:18:36 DEBUG [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp} to CLOSED
2024-03-19 13:18:36 INFO  [example.TicketObject/Reserve][inv_1kZ9CQR8abEw0sEs2Kgzztf2USUT1dzWIp] dev.restate.sdk.core.InvocationStateMachine - End invocation
// withClass highlight-line
2024-03-19 13:18:36 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/AddTicket
2024-03-19 13:18:36 INFO  [example.CartObject/AddTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:18:36 DEBUG [example.CartObject/AddTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to REPLAYING
2024-03-19 13:18:36 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to PROCESSING
2024-03-19 13:18:36 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:18:36 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz} to CLOSED
2024-03-19 13:18:36 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM958Np3tO3cffyYuVBbOtgtz] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>
</details>

Reduce the time the `TicketObject/reserve` function sleeps to a second, so you won't see the suspensions anymore.

<Admonition type="caution">
In keyed services, sleeping blocks all further processing (for the specific single key / all invocations, respectively).
</Admonition>

[//]: # (TODO show this on minikube with knative in a little video)

### Delayed calls

Take a look at a slightly different usage of timers.
In the application, a ticket gets reserved for 15 minutes.
If the user doesn't pay within that time interval, then it becomes available again to other users.

To do this, you can use a delayed call.
This is a one-way call that gets delayed by a specified duration.
This would make the `CartObject/addTicket` function look as follows:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part2/user_session.ts#<start_add_ticket>-<end_add_ticket>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part2/CartObject.java#<start_add_ticket>-<end_add_ticket>
```

</TabItem>
</Tabs>

To test it out, put the delay to a lower value, for example 5 seconds, call the `addTicket` function, and see in the logs how the call to `CartObject/expireTicket` is executed 5 seconds later.

<details>
<summary>Show the logs</summary>
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
... logs from reserve call ...
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
// highlight-next-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Function completed successfully.
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.092Z] DEBUG: Invoking function.
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Function completed successfully.
// highlight-next-line
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Invoking function.
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Function completed successfully.
```

</TabItem>
<TabItem value="java" label="Java">

```log
... logs from reserve call ...
2024-03-19 13:27:20 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM93WNxL0oqwxYDXEgzGZ9Lhv] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:27:20 DEBUG [example.CartObject/AddTicket][inv_1gdJBtdVEcM93WNxL0oqwxYDXEgzGZ9Lhv] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM93WNxL0oqwxYDXEgzGZ9Lhv} to CLOSED
// highlight-next-line
2024-03-19 13:27:20 INFO  [example.CartObject/AddTicket][inv_1gdJBtdVEcM93WNxL0oqwxYDXEgzGZ9Lhv] dev.restate.sdk.core.InvocationStateMachine - End invocation
// highlight-next-line
2024-03-19 13:27:25 DEBUG [example.CartObject/ExpireTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CartObject/ExpireTicket
2024-03-19 13:27:25 INFO  [example.CartObject/ExpireTicket] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:27:25 DEBUG [example.CartObject/ExpireTicket] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=WAITING_START, id=inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5} to REPLAYING
2024-03-19 13:27:25 DEBUG [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=REPLAYING, id=inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5} to PROCESSING
2024-03-19 13:27:25 INFO  [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:27:25 DEBUG [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CartObject', invocationState=PROCESSING, id=inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5} to CLOSED
2024-03-19 13:27:25 INFO  [example.CartObject/ExpireTicket][inv_1gdJBtdVEcM95LH9l9vt78qcw9W15wcwy5] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:27:25 DEBUG [example.TicketObject/Unreserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.TicketObject/Unreserve
2024-03-19 13:27:25 INFO  [example.TicketObject/Unreserve] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:27:25 DEBUG [example.TicketObject/Unreserve] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=WAITING_START, id=inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet} to REPLAYING
2024-03-19 13:27:25 DEBUG [example.TicketObject/Unreserve][inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=REPLAYING, id=inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet} to PROCESSING
2024-03-19 13:27:25 INFO  [example.TicketObject/Unreserve][inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:27:25 DEBUG [example.TicketObject/Unreserve][inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.TicketObject', invocationState=PROCESSING, id=inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet} to CLOSED
2024-03-19 13:27:25 INFO  [example.TicketObject/Unreserve][inv_1k78Krj3GqrK5NDYjHLWSD3Ass0GaOzeet] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>
</details>

Don't forget to set the delay back to 15 minutes.

<Admonition type="caution">
You can implement this pattern in different ways.
You could also sleep for 15 minutes at the end of the `addTicket` function and then call the `TicketObject/unreserve` function:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::ts/src/get_started/tour.ts#<start_sleep_and_send>-<end_sleep_and_send>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_sleep_and_send>-<end_sleep_and_send>
```

</TabItem>
</Tabs>

Be aware that sleeping in a keyed service blocks any invocations for that key.
In this case, the user would not be able to add any other tickets, nor buy the tickets.

If you do a sleep operation, the invocation is ongoing.
If you do a delayed call, the invocation isn't ongoing until the delay has passed, so no key is locked.

</Admonition>

<Admonition type="info">
üö© Explore the intermediate solution in `part2`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part2
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part2.AppMain run
```

</TabItem>
</Tabs>
</Admonition>

## Virtual Objects
<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part3"/>


In Restate, you implement your business logic in handlers that can be called by other services or external clients.
Handlers are bundled into Services or Virtual Objects.

- **Service**:
A collection of independent handlers. Just like the RPC services you know, but with Durable Execution on top.
- **Virtual Objects**:
A Virtual Object is a collection of handlers that share K/V state.
Each Virtual Object has a unique key.
Invocations are sequenced per Virtual Object: at most one handler can run at a time for a given Virtual Object.

In this example app, the `CheckoutService` is a plain Service, while the `TicketObject` and `CartObject` services are Virtual Objects.
The `TicketObject` is keyed by the ticket ID, while the `CartObject` service is keyed by the user ID.
So at most one invocation can run at a time for the same ticket ID or user ID respectively.

<Admonition type="tip">
    The concurrency guarantees of Virtual Objects can be useful to simplify reasoning about interaction with external systems.
    You can be sure that there is only a single ongoing invocation for a single key.
</Admonition>

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        **Specifying unkeyed services**

        You specify an unkeyed service by creating a router with its set of functions.
        For example, for the `CheckoutService`, you create a router with the `handle` function:

        ```typescript
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/checkout.ts#<start_checkout>-<end_checkout>
        ```

        The functions of an unkeyed router have two parameters:

        * A `ctx` of type `restate.Context` which allows to interact with Restate.
        * A `request` of type JSON object which represents additional invocation data.

        The `CheckoutService` only has a single function, but you can add more functions to the router if you want.

        **Specifying keyed services**

        You specify a keyed service by creating a keyed router with its set of functions.
        For example, the `CartObject` service has the following keyed router:

        ```typescript
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/app/user_session.ts#<start_user_session>-<end_user_session>
        ```

        The functions of a keyed router have three parameters

        * A `ctx` of type `restate.KeyedContext` which allows to interact with Restate.
        * A `key` parameter of type string which represents the key of the invoked service.
        * A `request` parameter of type JSON object which represents additional invocation data.

        You can choose the parameter names differently.

        As mentioned, for keyed services there can be at most one concurrent invocation to any method of the service.
        This means that for the same value of `key`, an unfinished call to `addTicket()` will block subsequent calls to `expireTicket()` or `checkout()` until `addTicket()` has finished.

        **Exporting the service API**

        You export the `service` API by creating a service API instance which specifies under which path the service is reachable.

        For example, for the `CartObject` service, you export the following service API:

        ```typescript
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part1/user_session.ts#<start_user_session_api>-<end_user_session_api>
        ```

        You can now call the service at the endpoint `http://localhost:8080/<servicePath>/<functionName>`.
        For example, you call the `addTicket` function of the `CartObject` service at `http://localhost:8080/CartObject/addTicket`, as you did earlier.

    </TabItem>
    <TabItem value="java" label="Java">

        You define a service by creating a class with the `@Service` annotation, as you can see in the `CheckoutService`.
        The handlers have the `@Handler` annotation:

        ```java
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CheckoutService.java#<start_service>-<end_service>
        ```

        Handlers have the Restate Context as the first argument and the request as the second argument.
        The actions you do on the Restate Context are durable tracked by Restate.
        Once an action has been logged in Restate, it will not get re-executed on retries.

        For Virtual Objects, you add the `@VirtualObject` annotation instead.
        Virtual Object handlers have the Restate `ObjectContext` as the first parameter, which gives some additional capabilities compared to the regular `Context` (e.g. K/V state access).


    </TabItem>
</Tabs>

## Persistent application state

Applications often need to keep state. For example, the `CartObject`
needs to track the shopping cart items.

Restate offers a key-value store to persistently store application state.

<Admonition type="tip" title="Good news!">
Restate's state is guaranteed to be consistent across retries and invocations.
This eliminates the need for a session database.
</Admonition>

The isolation level of the application state depends on the service type:
1. **Keyed service**: Application state is isolated per key.
All the invocations for the same key have access to the same application state.
Restate's state feature is most useful for this service type.
2. **Unkeyed service**: State is isolated per invocation. Using state isn't useful
for this service type.

### Getting and setting K/V state

Adapt the `CartObject/addTicket` function to keep track of the cart items.
After reserving the product, you add the ticket to the shopping cart.
Have a look at the highlighted code:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/user_session.ts#<start_add_ticket>-<end_add_ticket>
```

To retrieve the cart, you use `ctx.get`.
This returns `null` if the value has never been set.

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_add_ticket>-<end_add_ticket>
```

To retrieve the cart, you use `ctx.get` with a state key that describes the name and the (de)serializers to be used.
Have a look at the documentation on serialization to learn more about the different serializers.

`ctx.get` returns an Optional, only containing a value if one was set before.

</TabItem>
</Tabs>

You can store multiple key-value pairs, by using different state keys.
Here, you get the value under the key `"tickets"`.
Restate ensures that you get the cart belonging to the current user ID (key of the service).
After you added the ticket to the cart array, you set the state to the new value with `ctx.set`.

Run the services and call the `addTicket` function, to see the interaction with state.

<details>
<summary>Show the logs</summary>
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
... logs from reserve call ...
// highlight-start
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM97yGYEG5NWYtbMlnSAGHGY9][2024-03-19T08:55:20.941Z] DEBUG: Adding message to journal and sending to Restate ; GetStateEntryMessage
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM97yGYEG5NWYtbMlnSAGHGY9][2024-03-19T08:55:20.941Z] DEBUG: Adding message to journal and sending to Restate ; SetStateEntryMessage
// highlight-end
... logs from expireTicket call ...
```

You see that when you request the state, it gets logged in the journal.

</TabItem>
<TabItem value="java" label="Java">

To see the state interaction printed, you need to put the log level to trace in `src/main/resources/log4j.properties`:

```properties
logger.app.level = trace
```

Afterwards, you see the state interactions printed out in the logs.

```log
// withClass highlight-line
2024-03-19 13:33:09 TRACE [example.CartObject/AddTicket][inv_1gdJBtdVEcM95mQdTFiTz8hcbHoonhfww9] dev.restate.sdk.core.InvocationStateMachine - Writing to output message class dev.restate.generated.service.protocol.Protocol$GetStateEntryMessage key: "tickets"
value: "[\"456\"]"
2024-03-19 13:33:09 TRACE [example.CartObject/AddTicket][inv_1gdJBtdVEcM95mQdTFiTz8hcbHoonhfww9] dev.restate.sdk.http.vertx.HttpResponseFlowAdapter - Writing response message key: "tickets"
value: "[\"456\"]"
2024-03-19 13:33:09 TRACE [example.CartObject/AddTicket][inv_1gdJBtdVEcM95mQdTFiTz8hcbHoonhfww9] dev.restate.sdk.core.SyscallsImpl - set tickets
// withClass highlight-line
2024-03-19 13:33:09 TRACE [example.CartObject/AddTicket][inv_1gdJBtdVEcM95mQdTFiTz8hcbHoonhfww9] dev.restate.sdk.core.InvocationStateMachine - Writing to output message class dev.restate.generated.service.protocol.Protocol$SetStateEntryMessage key: "tickets"
value: "[\"456\"]"
2024-03-19 13:33:09 TRACE [example.CartObject/AddTicket][inv_1gdJBtdVEcM95mQdTFiTz8hcbHoonhfww9] dev.restate.sdk.http.vertx.HttpResponseFlowAdapter - Writing response message key: "tickets"
value: "[\"456\"]
```


</TabItem>
</Tabs>

</details>

<Admonition type="info" title="Serialization">
<Tabs>
<TabItem value="ts" label="TypeScript">
You can store any object in the state as long as the value can be serialized with `Buffer.from(JSON.stringify(yourObject))`.
</TabItem>
<TabItem value="java" label="Java">
To enable the Restate SDK to serialize arbitrary objects, add the `dev.restate:sdk-serde-jackson:VAR::JAVA_SDK_VERSION` dependency.
</TabItem>
</Tabs>
</Admonition>

When starting the invocation, Restate attaches the application state to the request.
So when you operate on the state in your function with `ctx.get` and `ctx.set`, you get access to a local copy of the state for fast access.

### Inspecting K/V state

Restate exposes information on invocations and application state via its Introspection SQL API. You can use this to gain insight into the status of invocations and the service state that is stored.
You can inspect the application state of the `CartObject` service by using psql, as follows:

```shell
psql -h localhost -p 9071 -c "SELECT * FROM state WHERE service like '%CartObject%';"
```

Or watch how the state changes with:

```shell
watch -n 1 'psql -h localhost -p 9071 -c "SELECT * FROM state WHERE service like '\''%CartObject%'\''";'
```

Add several tickets to the state to see how the query result gets updated.

You can also stop and relaunch the service, to see that this has no influence on the tickets.

Now, adapt the `CartObject/checkout` function, to use the tickets:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/user_session.ts#<start_checkout>-<end_checkout>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_checkout>-<end_checkout>
```

</TabItem>
</Tabs>

After the tickets are checked out, you clear the state with `ctx.clear`.
Send a checkout request as [earlier](#calling-services-from-outside-restate), and check via psql that the state is empty.


<Admonition type="tip">
Have a look at the documentation on [introspection](/operate/introspection) to learn more about inspecting the invocation status and application state.
</Admonition>


### üìù Try it out

#### Finishing `CartObject/expireTicket`

You have almost fully implemented the `CartObject`. After checkout, let's finish `CartObject/expireTicket`.
Before you call `unreserve`, you first need to check if the ticket is still held by the user.
Retrieve the state and check if the ticket ID is in there.
If this is the case, then you call `TicketObject/unreserve` and remove it from the state.

<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/user_session.ts#<start_expire_ticket>-<end_expire_ticket>
```

Call the `expireTicket` function with:
```shell
curl localhost:8080/CartObject/expireTicket \
-H 'content-type: application/json' \
-d '{"key": "Mary", "request": "456"}'
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_expire_ticket>-<end_expire_ticket>
```

Call the `expireTicket` function with:
```shell
curl localhost:8080/example.CartObject/ExpireTicket \
-H 'content-type: application/json' \
-d '{"user_id": "Mary", "ticket_id": "456"}'
```

</TabItem>
</Tabs>

</details>

#### Implementing the `TicketObject`

You can track the status of the tickets in the `TicketObject` by storing it in the state.
Implement the `TicketObject/reserve`, `TicketObject/unreserve`, and `TicketObject/markAsSold` functions to do this.

While you are developing them, you can use psql to monitor the state of the `TicketObject`:

```shell
watch -n 1 'psql -h localhost -p 9071 -c "select service, service_key, key, value_utf8 from state where service like '\''%TicketObject%'\''";'
```

1. Implement the `TicketObject/reserve` function.
The function first retrieves the value for the `"status"` state key.
If the value is set to `TicketStatus.Available`, then change it to `TicketStatus.Reserved` and
return `true` (reservation successful).
If the status isn't set to `TicketStatus.Available`, then return `false`.
Remove the sleep that you added before.

<>
<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/ticket_service.ts#<start_reserve>-<end_reserve>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_reserve>-<end_reserve>
```

</TabItem>
</Tabs>

Now, you can't reserve the same ticket multiple times anymore.
Call `addTicket` multiple times for the same ID. The first time it returns `true`, afterwards `false`.
</details>
</>

2. Implement the `TicketObject/unreserve` function.
The function should clear the value of the `"status"` key if it's not on status `TicketStatus.Sold`.

<>
<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/ticket_service.ts#<start_unreserve>-<end_unreserve>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_unreserve>-<end_unreserve>
```
</TabItem>
</Tabs>

Now, the ticket reservation status is cleared when the delayed `expireTicket` call triggers.
Play around with reducing the delay of the `expireTicket` call in the `addTicket` function.
Try to reserve the same ticket ID multiple times, and see how you are able to reserve it again after the `unreserve` function executed.

</details>
</>

3. Implement the `TicketObject/markAsSold` function.
The function should set the value of the `"status"` key to `TicketStatus.Sold` if it's reserved.

<>
<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part3/ticket_service.ts#<start_mark_as_sold>-<end_mark_as_sold>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_mark_as_sold>-<end_mark_as_sold>
```
</TabItem>
</Tabs>

In the next section, you implement the `CheckoutService/handle` function that calls `markAsSold`.
This ties the final parts together.
</details>
</>

<Admonition type="info">
üö© Explore the intermediate solution in `part3`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part3
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part3.AppMain run
```

</TabItem>
</Tabs>
</Admonition>


## Determinism & side effects

<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part4"/>

Restate's replay mechanism makes applications resilient to failures.
For the replay to work, code needs to be deterministic, otherwise the replayed entries do not line up with the code execution on retries.
For non-deterministic code, the SDK offers side effects, for example, to log the result of communication with external systems.
The SDK also offers helper functions for creating UUIDs and generating random numbers.

In `CheckoutService/handle`, we first want to trigger the payment. This happens in two steps:
1. First, we use the SDK helper functions to generate an idempotency token for the payment.
This token will be supplied in the payment request to ensure that a customer never pays multiple times.
2. Then, we use a side effect to trigger the payment via an external payment provider (`PaymentClient`).
You can find a payment client stub in `auxiliary/PaymentClient`. Do the following:
    1. Create a new payment client in `CheckoutService/handle`.
    2. From within a side effect, execute the payment via `paymentClient.call(idempotencyKey, amount)`.
    Assume every ticket costs 40 dollars.
    Store the boolean result of the call as the return value of the side effect.

The side effect executes the supplied function and stores the return value in Restate.
Upon replay, the stored value gets inserted and the function doesn't get re-executed.

Add the following code snippet to the `CheckoutService/handle` function:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part4/checkout.ts#<start_side_effects>-<end_side_effects>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part4/CheckoutService.java#<start_side_effects>-<end_side_effects>
```

</TabItem>
</Tabs>


The idempotency token will be the same during retries. To experiment with this, you can print the idempotency key to the console and then throw an error to see how it gets replayed:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::ts/src/get_started/tour.ts#<start_idempotency_key_retry>-<end_idempotency_key_retry>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_idempotency_key_retry>-<end_idempotency_key_retry>
```

Comment out the return statement to make this compile, otherwise it fails with `error: unreachable statement`.

</TabItem>
</Tabs>

Call `CartObject/checkout` and have a look at the logs to see what happens.
Don't forget to remove the throwing of the error again before you continue.

<details>
<summary>Show the logs</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
... logs of `CartObjectService/CheckoutService` ...
[restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.498Z] DEBUG: Invoking function.
// withClass highlight-line
My idempotency key: e25b747f-ecfb-443b-8939-1935392aab6b
Trace: [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.499Z] TRACE: Function completed with an error: Something happened! Error: Something happened!
... rest of trace  ...
[restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.512Z] DEBUG: Invocation ended with retryable error. ; ErrorMessage
[restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] DEBUG: Invoking function.
// withClass highlight-line
My idempotency key: e25b747f-ecfb-443b-8939-1935392aab6b
Trace: [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] TRACE: Function completed with an error: Something happened! Error: Something happened!
... rest of trace  ...
[restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] DEBUG: Invocation ended with retryable error. ; ErrorMessage
... retries continue ...
```

</TabItem>
<TabItem value="java" label="Java">

```log
2024-03-19 13:48:31 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:48:31 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:48:31 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P} to REPLAYING
// withClass highlight-line
My idempotency key: cca5efdf-c06f-987e-c717-2cf0490aa5f5
2024-03-19 13:48:31 WARN  [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.GrpcUnaryRpcHandler - Error when processing the invocation
java.lang.IllegalStateException: Something went wrong.
... rest of trace ...
2024-03-19 13:48:31 DEBUG [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P} to CLOSED
2024-03-19 13:48:31 INFO  [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:48:41 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:48:41 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:48:41 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P} to REPLAYING
// withClass highlight-line
My idempotency key: cca5efdf-c06f-987e-c717-2cf0490aa5f5
2024-03-19 13:48:41 WARN  [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.GrpcUnaryRpcHandler - Error when processing the invocation
java.lang.IllegalStateException: Something went wrong.
... rest of trace ...
2024-03-19 13:48:41 DEBUG [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P} to CLOSED
2024-03-19 13:48:41 INFO  [example.CheckoutService/Handle][inv_1gzPpb62mftx5SkM372RRab9OLi3kREi5P] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>

</details>

<Admonition type="tip">
You can use a side effect to avoid re-execution during replay for any arbitrary piece of user code.
This includes pieces of time-consuming, deterministic user code.
</Admonition>

<Admonition type="caution">
You can't execute any context calls from within a side effect.
This is invalid code.
</Admonition>

### üìù Try it out
Once this works, you implement the rest of the checkout workflow:
- If the payment call was successful, then:
    - use the EmailClient to notify the users of the payment success.
    Prevent duplicate emails during retries by using a side effect.
    - let the calling `CartObject` mark all tickets as sold via `TicketObject/markAsSold`.
- If the payment call was unsuccessful, then:
    - use the EmailClient to notify the users of the payment failure.
    Prevent duplicate emails during retries by using a side effect.

<details>
<summary>Solution</summary>

The `CheckoutService/handle` function now looks like the following:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part4/checkout.ts#<start_checkout>-<end_checkout>
```

</TabItem>
<TabItem value="java" label="Java">

[//]: # (```java)

[//]: # (CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part4/CheckoutService.java#<start_checkout>-<end_checkout>)

[//]: # (```)

</TabItem>
</Tabs>

The `CartObject/checkout` function now looks like the following:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part4/user_session.ts#<start_checkout>-<end_checkout>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part4/CartObject.java#<start_checkout>-<end_checkout>
```

</TabItem>
</Tabs>

</details>


ü•≥ Except for a few resiliency tweaks, you have now fully implemented the ticket reservation system!
Try it out by reserving some new tickets and buying them by checking out the cart.

<Admonition type="info">
üö© Explore the intermediate solution in `part4`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part4
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part4.AppMain run
```

</TabItem>
</Tabs>
</Admonition>


## Resiliency

<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part5"/>

As you have discovered throughout this tutorial, Restate makes your applications resilient out-of-the-box by:

- Making sure messages can't get lost by durably storing all calls in the log.
No more queues needed for asynchronous calls.
- Retrying failed invocations.
No more retry logic required for inter-service communication.
- Restoring partial progress of invocations, via its durable execution mechanism.
For example, if a service goes down due to an infrastructure failure, the ongoing invocations resume at the point in the user code where they left off.
- Ensuring consistent application state with its key-value store.
- Providing end-to-end exactly-once guarantees for incoming invocations.

<Admonition type="tip" title="Good news!">
These features are switched on by default. No need to do anything.
</Admonition>

### Side effect retries

Also side effects are retried until they succeed.
You can observe this behavior by using the `paymentClient.failingCall` in `CheckoutService/handle`:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/main/tutorials/tour-of-restate-typescript/src/part5/checkout.ts#<start_failing_client>-<end_failing_client>
```

</TabItem>
<TabItem value="java" label="Java">

```java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/tour_new_api/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part5/CheckoutService.java#<start_failing_client>-<end_failing_client>
```
</TabItem>
</Tabs>

You now call `paymentClient.failingCall` which fails two times before succeeding.
A failing side effect is retried until it succeeds.
Have a look at the logs to see the retries.

<details>
<summary>Show the logs</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.676Z] DEBUG: Invoking function.
// highlight-next-line
Payment call failed for idempotency key 608e3977-7c91-4fc2-bf56-3c9c0c2cbabd and amount 40. Retrying...
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.678Z] DEBUG: Adding message to journal and sending to Restate ; SideEffectEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.678Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.679Z] DEBUG: Received entry ack message from Restate, adding to journal. ; EntryAckMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.680Z] DEBUG: Error while executing side effect 'side-effect': Error - Payment call failed
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.692Z] DEBUG: Error: Payment call failed
... rest of trace ...
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.692Z] DEBUG: Retrying in 10 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.692Z] DEBUG: Adding message to journal and sending to Restate ; SleepEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.692Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.705Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
// highlight-next-line
Payment call failed for idempotency key 608e3977-7c91-4fc2-bf56-3c9c0c2cbabd and amount 40. Retrying...
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.705Z] DEBUG: Adding message to journal and sending to Restate ; SideEffectEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.705Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.706Z] DEBUG: Received entry ack message from Restate, adding to journal. ; EntryAckMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.706Z] DEBUG: Error while executing side effect 'side-effect': Error - Payment call failed
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.707Z] DEBUG: Error: Payment call failed
... rest of trace ...
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.707Z] DEBUG: Retrying in 20 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.707Z] DEBUG: Adding message to journal and sending to Restate ; SleepEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.707Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.730Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
Payment call succeeded for idempotency key 608e3977-7c91-4fc2-bf56-3c9c0c2cbabd and amount 40
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.730Z] DEBUG: Adding message to journal and sending to Restate ; SideEffectEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.730Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.731Z] DEBUG: Received entry ack message from Restate, adding to journal. ; EntryAckMessage
// highlight-next-line
Notifying user Mary of payment success
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.731Z] DEBUG: Adding message to journal and sending to Restate ; SideEffectEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.732Z] DEBUG: Scheduling suspension in 30000 ms
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.732Z] DEBUG: Received entry ack message from Restate, adding to journal. ; EntryAckMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.733Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
[restate] [CheckoutService/handle][inv_1eVZwghxruIa0YY4RtWg1viemwoyZ7Q6Ot][2024-03-19T10:19:02.733Z] DEBUG: Function completed successfully.
```


</TabItem>
<TabItem value="java" label="Java">

```log
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to REPLAYING
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to PROCESSING
// withClass highlight-line
Payment call failed for idempotency key f205fbd1-dd6b-e864-ce50-2ec2e196b50e and amount 40.0. Retrying...
2024-03-19 13:51:48 WARN  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Invocation failed
java.lang.IllegalStateException: Payment call failed
... rest of trace ...
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=PROCESSING, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to CLOSED
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to REPLAYING
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to PROCESSING
// withClass highlight-line
Payment call failed for idempotency key f205fbd1-dd6b-e864-ce50-2ec2e196b50e and amount 40.0. Retrying...
2024-03-19 13:51:48 WARN  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Invocation failed
java.lang.IllegalStateException: Payment call failed
... rest of trace ...
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=PROCESSING, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to CLOSED
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to example.CheckoutService/Handle
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle] dev.restate.sdk.core.RestateEndpoint - Start processing invocation
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=WAITING_START, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to REPLAYING
2024-03-19 13:51:48 DEBUG [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - Transitioning InvocationStateMachine{serviceName='example.CheckoutService', invocationState=REPLAYING, id=inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf} to PROCESSING
// withClass highlight-line
Payment call succeeded for idempotency key f205fbd1-dd6b-e864-ce50-2ec2e196b50e and amount 40.0
// withClass highlight-line
Notifying user Mary of payment success
2024-03-19 13:51:48 INFO  [example.CheckoutService/Handle][inv_1bTsZIo2tGFY7McwmD7UYoIhrhvfQm23Rf] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>

</details>

<Admonition type="tip">
Have a look at the error handling documentation(for [TypeScript](/develop/ts/error-handling) or [Java](/develop/java/error-handling))  to learn how to make a call fail terminally (without retries).
</Admonition>

## Tracing
Restate exposes OpenTelemetry traces of your invocations.

Run the Jaeger container with:

```shell
docker run -d --name jaeger \
    -e COLLECTOR_OTLP_ENABLED=true \
    -p 4317:4317 \
    -p 16686:16686 \
    jaegertracing/all-in-one:1.46
```

Then stop the Restate container and start it again with the tracing endpoint defined as an environment variable:

```shell
docker run --name restate_dev --rm \
    -e RESTATE_OBSERVABILITY__TRACING__ENDPOINT=http://host.docker.internal:4317 \
    -p 8080:8080 -p 9070:9070 -p 9071:9071 \
    --add-host=host.docker.internal:host-gateway \
    docker.io/restatedev/restate:VAR::RESTATE_VERSION
```

Register the services again (required because the state got wiped when the runtime was restarted with the `--rm` flag):
```shell
curl localhost:9070/deployments -H 'content-type: application/json' -d '{"uri": "http://host.docker.internal:9080"}'
```

Send requests to the runtime by adding tickets and checking out.

Go to the Jaeger UI at http://localhost:16686.

In the Jaeger UI, select the `CartObject` service from the service dropdown.
You should see the `addTicket` and `checkout` requests listed:

![Jaeger traces tour](/img/jaeger_traces_tour_handler.png)

Have a look at the traces of the `checkout` call:

![CheckoutService call traces](/img/jaeger_checkout_traces_tour_handler.png)

You can see the calls that were done to Restate, for example invoke, sleep, one way call, get state, etc., and their timings.
If you expand one of the traces, you can see tags describing some metadata of the context call, for example invocation id and call arguments.

For more information, have a look at the [tracing docs](/operate/monitoring/tracing).

## üèÅ The end
You reached the end of this tutorial!

<Admonition type="info" title="Done!">
üö© Have a look at the fully implemented app in `part5`, and run it with:
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part5
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part5.AppMain run
```

</TabItem>
</Tabs>
</Admonition>


Let's recap what you've covered:
- reliable, suspendable request-response calls
- one-way calls without the need for queues
- suspensions for external communication
- durable timers for sleep or for calling other services
- concurrency guarantees for keyed/unkeyed services
- persistent application state
- storing the results of non-deterministic operations or external calls as side effects
- resiliency and retries
- tracing with Jaeger

## Next steps
- [Have a look at the examples](https://github.com/restatedev/examples)
- [Check out the Java SDK documentation](/category/java-sdk)
- [Check out the TypeScript SDK documentation](/category/typescript-sdk)
