---
id: tour
title: "Tour of Restate"
description: ""
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';
import {SubtleStep} from "../../src/components/Stepper";
import TourAnimation from "../../src/components/TourAnimation";
import CliAnimation from "../../src/components/CliAnimation";

<Tabs groupId="sdk" queryString>
<TabItem value="ts" label="TypeScript">
</TabItem>
<TabItem value="java" label="Java">
</TabItem>
</Tabs>

This tutorial guides you through the development of an end-to-end Restate application, and covers all the essential features.
After this tutorial, you should have a firm understanding of how Restate can help you and feel comfortable to tackle your next application on your own.

This tutorial implements a ticket reservation application for a theatre.
It allows users to add tickets for specific seats to their shopping cart.
After the user adds a ticket, the seat gets reserved for 15 minutes.
If the user doesn't pay for the ticket within that time interval, the reservation is released and the ticket becomes available to other users.

Restate applications are made up of services that expose handlers.
Handlers are functions that implement business logic.
Restate manages their invocation and execution.
Services communicate with one another using Remote Procedure Calls (RPC).
Our ticket example consists of three services:

<img src="/img/tour-overview.svg" width="70%"/>

As we go, you will discover how Restate can help you with some intricacies in this application.

<Admonition type="note" title="Prerequisites">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

- Latest stable version of [NodeJS](https://nodejs.org/en/) >= v18.17.1 and [npm CLI](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) >= 9.6.7 installed.
- Restate CLI: [Installation instructions](/operate/cli#installation)
- Optional: [Docker Engine](https://docs.docker.com/engine/install/) or [Podman](https://podman.io/docs/installation), if you want to run the Restate Server with Docker. And to run Jaeger.

This guide is written for:
- TypeScript SDK version: `VAR::TYPESCRIPT_SDK_VERSION`
- Restate runtime Docker image: `docker.io/restatedev/restate:VAR::RESTATE_VERSION`

</TabItem>
<TabItem value="java" label="Java">
- JDK >= 11
- Restate CLI: [Installation instructions](/operate/cli#installation)
- Optional: [Docker Engine](https://docs.docker.com/engine/install/) or [Podman](https://podman.io/docs/installation), if you want to run the Restate Server with Docker. And to run Jaeger.

This guide is written for:
- Java SDK version: `VAR::JAVA_SDK_VERSION`
- Restate runtime Docker image: `docker.io/restatedev/restate:VAR::RESTATE_VERSION`

</TabItem>
</Tabs>
</Admonition>

## Getting Started

<SubtleStep stepLabel="1" title="Set up the services">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">
- Run the services in the browser:

    <a className="btn btn-primary btn-lg"
       href="https://stackblitz.com/github/restatedev/examples/tree/dev_0.9/tutorials/tour-of-restate-typescript?startScript=app-dev&embed=1&file=src%2Fapp%2Fapp.ts,src%2Fapp%2Fcheckout_service.ts,src%2Fapp%2Fticket_object.ts,src%2Fapp%2Fcart_object.ts&theme=dark&view=editor"
       target="_blank"
       role="button"><img className="buttonIcon" src="/img/open_in_stackblitz.svg"
                          alt="TypeScript Quickstart"></img></a>
- Or download the example and run locally with an IDE:
<CH.Code>
    ```shell CLI
    restate example typescript-tour-of-restate && cd typescript-tour-of-restate
    ```

    ```shell wget
    wget https://github.com/restatedev/examples/releases/latest/download/typescript-tour-of-restate.zip &&
        unzip typescript-tour-of-restate.zip -d typescript-tour-of-restate &&
        rm typescript-tour-of-restate.zip
    ```
</CH.Code>

Install the dependencies and build the app:
```shell
npm install && npm run build
```

Run the services

```shell
npm run app-dev
```

</TabItem>
<TabItem value="java" label="Java">

<CH.Code>
```shell CLI
restate example java-tour-of-restate && cd java-tour-of-restate
```

```shell wget
wget https://github.com/restatedev/examples/releases/latest/download/java-tour-of-restate.zip &&
    unzip java-tour-of-restate.zip -d java-tour-of-restate &&
    rm java-tour-of-restate.zip && cd java-tour-of-restate
```
</CH.Code>
Run the services

```shell
./gradlew run
```

</TabItem>
</Tabs>

This [GitHub repository](https://github.com/restatedev/examples/tree/main/tutorials/tour-of-restate-java) contains the basic skeleton of the Java services that you develop in this tutorial.

</SubtleStep>

<SubtleStep stepLabel="2" title="Launch Restate">

<CH.Code rows={"2"}>

    ```shell npx
    npx @restatedev/restate-server
    ```

    ``` shell Homebrew
    brew install restatedev/tap/restate-server && restate-server
    ```

    ```shell Docker
    docker run --name restate_dev -p 8080:8080 -p 9070:9070 -p 9071:9071 \
        --add-host=host.docker.internal:host-gateway docker.io/restatedev/restate:VAR::RESTATE_VERSION
    ```

</CH.Code>

<Admonition type="tip" icon="üí°" title="Single binary">
    Restate is a single self-contained binary. No external dependencies needed. Check out our [download page](https://restate.dev/get-restate/) for other ways to run Restate.
</Admonition>

</SubtleStep>

<SubtleStep stepLabel="3" title="Register the services with Restate">

Now, we need to tell Restate where our services are running.
You can register services by calling the Restate Admin API (default port `9070`) and supplying it the service endpoint URI:

<CH.Code rows={"2"}>

    ```shell CLI
    restate deployments register http://localhost:9080
    ```

    ```shell curl
    curl localhost:9070/deployments -H 'content-type: application/json' \
        -d '{"uri": "http://localhost:9080"}'
    ```

</CH.Code>
<details className="grey-details">
    <summary>Output</summary>

    ```json
    {
        "id": "bG9jYWxob3N0OjgwODAv",
        "services": [
    {
        "name": "TicketObject",
        /* ... Additional information on registered methods ...*/
    },
    {
        "name": "CartObject",
        /* ... Additional information on registered methods ...*/
    },
    {
        "name": "CheckoutService",
        /* ... Additional information on registered methods ...*/
    }
        ]
    }
    ```

</details>

If you run Restate with Docker, replace `http://localhost:9080` by `http://host.docker.internal:9080`.
</SubtleStep>

<SubtleStep stepLabel="üöÄ" title="All set up!">
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">
In `src/app` you will find the skeletons of the various services to help you start implementing the app.
    For example:
    ```typescript checkout_service.ts
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part1/checkout_service.ts#<start_checkout>-<end_checkout>
    ```

    Restate handlers have the Restate Context supplied as the first argument.
    This is the entrypoint to the SDK.

    The `app.ts` file contains the definition of the endpoint that hosts the services.


</TabItem>
<TabItem value="java" label="Java">
In `src/main/java/dev/restate/tour/app` you will find the skeletons of the various services to help you start implementing the app.
For example:
```java CheckoutService.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CheckoutService.java#<start_service>-<end_service>
```

Services are annotated by `@Service`. A service consists of a set of handlers, and each handler is annotated by `@Handler`.

Restate handlers have the Restate Context supplied as the first argument.
This is the entrypoint to the SDK.

The `AppMain.java` file contains the definition of the endpoint that hosts the services.
</TabItem>
</Tabs>
</SubtleStep>


## Invoking Handlers
<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part1"/>

Handlers can be invoked in several ways: via HTTP requests, programmatically with the SDK, or via Kafka events.

### Request-response calls over HTTP
Let's start with invoking our handler over HTTP using `curl`.

For example, add a ticket `seat2B` to the cart of Mary by calling the `addTicket` handler of the `CartObject`:

```shell
curl localhost:8080/CartObject/Mary/addTicket -H 'content-type: application/json' -d '"seat2B"'
```

If this prints out `true`, then you have a working setup.

When Mary wants to proceed with the purchase, call the `checkout` handler of the `CartObject`:

```shell
curl -X POST localhost:8080/CartObject/Mary/checkout
```

We will use these two `curl` commands often when developing the code, so keep them handy.

<Admonition type="note" title="Restate as proxy">
    Restate acts as a proxy for your services. It forwards the request to the correct service and handler.
    Therefore, the request is sent to Restate and not directly to the service.
</Admonition>

<Admonition type="note" title={<>Why does the path contain <code>Mary</code>?</>}>
    Handlers are either a part of plain services or Virtual Objects.
    Virtual Objects are a special type of service that allows you to group handlers together, share state between them, and control concurrency.
    Each Virtual Object has a unique key.
    We will cover the difference in more detail later.
    For now, it's important to note that when invoking a handler within a Virtual Object, you need to specify its key.
    In our example, the `CartObject` and `TicketObject` are Virtual Objects, while the `CheckoutService` is a plain service.
    To add the ticket to Mary's cart, we need to specify the key `Mary` in the path to reach her Virtual Object.
</Admonition>

We can do the same programmatically within a handler by using the SDK. Let's try this out!

### Request-response calls between handlers

You can also call other handlers programmatically by using the clients generated by the Restate SDK.
Let's try this out!

When we add a ticket to the cart, the `CartObject/addTicket` handler first needs to reserve the ticket for the user.
It does that by calling the `TicketObject/reserve` handler:

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```typescript cart_object.ts
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part1/cart_object.ts#<start_add_ticket>-<end_add_ticket>
        ```
        <details className="grey-details">
            <summary>Service logs</summary>

            ```log
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.790Z] DEBUG: Invoking function.
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.792Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.792Z] DEBUG: Scheduling suspension in 30000 ms
            // withClass highlight-line
            [restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Invoking function.
            [restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            // withClass highlight-line
            [restate] [TicketObject/reserve][inv_1k78Krj3GqrK6odGaRe866kHZilkVf1H4l][2024-03-18T16:30:28.796Z] DEBUG: Function completed successfully.
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.799Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.800Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM95mw1LLMMJY1Y0thJ9ugFGN][2024-03-18T16:30:28.800Z] DEBUG: Function completed successfully.
            ```

        </details>

        1. **Create the client** via `ctx.serviceClient` or `ctx.objectClient` (for Virtual Objects). Specify the service definition (`TicketObject`) and optionally the Virtual Object key (`ticketId`).
        2. **Specify the handler** you want to call and supply the request. Here `reserve()`.
        3. **Await the response** of the call.

        Send a request to `CartObject/addTicket` as we did [previously](#request-response-calls-over-http), and have a look at the service logs.

    </TabItem>
    <TabItem value="java" label="Java">

        ```java CartObject.java
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_add_ticket>-<end_add_ticket>
        ```

        <details className="grey-details">
            <summary>Service logs</summary>

            ```log
            // withClass highlight-line
            2024-04-16 17:18:59 DEBUG [CartObject/addTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/addTicket
            2024-04-16 17:18:59 INFO  [CartObject/addTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:19:00 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:19:00 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): InvokeEntryMessage
            // withClass highlight-line
            2024-04-16 17:19:00 DEBUG [TicketObject/reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to TicketObject/reserve
            2024-04-16 17:19:00 INFO  [TicketObject/reserve] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:19:00 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz1fARH9n1r2H1YjjsTZxei5] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:19:00 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz1fARH9n1r2H1YjjsTZxei5] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): OutputEntryMessage
            2024-04-16 17:19:00 INFO  [TicketObject/reserve][inv_1aAMfXkieWDz1fARH9n1r2H1YjjsTZxei5] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:19:00 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz1fARH9n1r2H1YjjsTZxei5] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:19:00 INFO  [TicketObject/reserve][inv_1aAMfXkieWDz1fARH9n1r2H1YjjsTZxei5] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:19:00 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [2](): OutputEntryMessage
            2024-04-16 17:19:00 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:19:00 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:19:00 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH5LkrvugCbFBq1VKcNrjuzn] dev.restate.sdk.core.InvocationStateMachine - End invocation
            ```
        </details>

        1. **Use the pre-generated client** (`TicketObject`): This gets generated when you compile the code for the first time.
        So if you haven't done that yet, run `./gradlew build` to generate the client.
        2. **Supply the context** (and specify the Virtual Object) key via `fromContext(ctx, ticketId)`.
        3. **Specify the handler** you want to call and supply the request. Here `reserve()`.
        4. **Await the response** of the call.

        Once you have added this to the code, restart the service, call the `CartObject/addTicket` method as we did [previously](#request-response-calls-over-http), and have a look at the service logs.

    </TabItem>
</Tabs>


### Sending messages between handlers

We can also let handlers send messages to other handlers without waiting for a response.

In the example, when a seat gets added to the shopping cart, it gets reserved for 15 minutes.
When a user didn't proceed with the payment before the timeout, the `CartObject/expireTicket` handler is triggered.
Let the `expireTicket` handler call the `TicketObject/unreserve` handler.

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript cart_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part1/cart_object.ts#<start_expire_ticket>-<end_expire_ticket>
```

Specify that you want to call the `TicketObject` by supplying `ticketObjectApi` to the `send` function.
Then call the `unreserve` handler on the `TicketObject`.

Once you have added this to the code, call the `CartObject/expireTicket` handler:

```shell
curl localhost:8080/CartObject/Mary/expireTicket-H 'content-type: application/json' -d '"seat2B"'
```
<details className="grey-details">
    <summary>Service logs</summary>

    ```log
    [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.671Z] DEBUG: Invoking function.
    [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.672Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
    [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.673Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
    // withClass highlight-line
    [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM942bjcDmb1c1khoaJe11Hbz][2024-03-18T16:14:24.673Z] DEBUG: Function completed successfully.
    [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Invoking function.
    [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
    // withClass highlight-line
    [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK3GuJXkgaXBbg69R47TCeAN][2024-03-18T16:14:24.677Z] DEBUG: Function completed successfully.
    ```

</details>
</TabItem>
<TabItem value="java" label="Java">

```java CartObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_expire_ticket>-<end_expire_ticket>
```
You now call `send()` on the generated client to send a message instead of doing a request-response call.
You also don't need to await the response, as you don't expect one.

Call the handler via:
```shell
curl localhost:8080/CartObject/Mary/expireTicket-H 'content-type: application/json' -d '"seat2B"'
```
<details className="grey-details">
    <summary>Service logs</summary>

    ```log
    // withClass highlight-line
    2024-04-16 17:27:45 DEBUG [CartObject/expireTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/expireTicket
    2024-04-16 17:27:45 INFO  [CartObject/expireTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
    2024-04-16 17:27:45 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
    2024-04-16 17:27:45 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): BackgroundInvokeEntryMessage
    2024-04-16 17:27:45 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [2](): OutputEntryMessage
    2024-04-16 17:27:45 INFO  [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - End invocation
    2024-04-16 17:27:45 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
    // withClass highlight-line
    2024-04-16 17:27:45 INFO  [CartObject/expireTicket][inv_1aiqX0vFEFNH0T0mRlvCk7xTVSB5xQIaKR] dev.restate.sdk.core.InvocationStateMachine - End invocation
    // withClass highlight-line
    2024-04-16 17:27:45 DEBUG [TicketObject/unreserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to TicketObject/unreserve
    2024-04-16 17:27:45 INFO  [TicketObject/unreserve] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
    2024-04-16 17:27:45 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz6IcQAkXhOPoZ3T9A9KTC3D] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
    2024-04-16 17:27:45 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz6IcQAkXhOPoZ3T9A9KTC3D] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): OutputEntryMessage
    2024-04-16 17:27:45 INFO  [TicketObject/unreserve][inv_1aAMfXkieWDz6IcQAkXhOPoZ3T9A9KTC3D] dev.restate.sdk.core.InvocationStateMachine - End invocation
    2024-04-16 17:27:45 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz6IcQAkXhOPoZ3T9A9KTC3D] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
    2024-04-16 17:27:45 INFO  [TicketObject/unreserve][inv_1aAMfXkieWDz6IcQAkXhOPoZ3T9A9KTC3D] dev.restate.sdk.core.InvocationStateMachine - End invocation
    ```

</details>
</TabItem>
</Tabs>

The service logs show how the `expireTicket` handler gets executed and then the `unreserve` handler.
The call to `expireTicket` finishes earlier than the `unreserve` handler because `expireTicket` didn't wait for the response of the `unreserve` handler.

<Admonition type="tip" title="Restate as message queue">
Restate persists and retries failed one-way invocations. There is no need to set up message queues to ensure delivery!
</Admonition>

<Admonition type="info" title="Sending messages via `curl`">
To send messages via `curl`, add `/send` to the handler path:
```shell
curl localhost:8080/CartObject/Mary/addTicket/send -H 'content-type: application/json' -d '"seat2B"'
```

<details className="grey-details">
<summary>Output</summary>
```json
{"invocationId":"inv_1aiqX0vFEFNH1Umgre58JiCLgHfTtztYK5"}
```
</details>

This returns the invocation ID. This is a unique identifier for the invocation.
You can use it to track the progress of the invocation via the CLI, and to correlate logs and metrics.
</Admonition>

### üìù Try it out

Make the `CartObject/checkout` handler call the `CheckoutService/handle` handler.

For the request field, you can use a hard-coded string array for now: `["seat2B"]`.
You will fix this later on. Note that the `CheckoutService` is not a Virtual Object, so you don't need to specify a key.

<details>
    <summary>Solution</summary>

    Add the following code to the `CartObject/checkout` handler:

    <Tabs groupId="sdk" queryString className={"display-none"}>
        <TabItem value="ts" label="TypeScript">

            ```typescript cart_object.ts
            CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part1/cart_object.ts#<start_checkout>-<end_checkout>
            ```

            Call `CartObject/checkout` as you did [earlier](#request-response-calls-over-http) and have a look at the logs again to see what happened:

            ```log
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.018Z] DEBUG: Invoking function.
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.019Z] DEBUG: Adding message to journal and sending to Restate ; InvokeEntryMessage
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.020Z] DEBUG: Scheduling suspension in 30000 ms
            [restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.023Z] DEBUG: Invoking function.
            [restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.024Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            [restate] [CheckoutService/handle][inv_16WnWCiCVV5G2gUUevDM4uIli4v7TN9k2d][2024-03-19T07:57:24.024Z] DEBUG: Function completed successfully.
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.026Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.027Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            [restate] [CartObject/checkout][inv_1gdJBtdVEcM919dOBhoVBm3fUMlaIHnANr][2024-03-19T07:57:24.027Z] DEBUG: Function completed successfully.
            ```

        </TabItem>
        <TabItem value="java" label="Java">

            ```java CartObject.java
            CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_checkout>-<end_checkout>
            ```

            Restart the service and call the `CartObject/checkout` handler as you did earlier and have a look at the logs again to see what happened.

            ```log
            // withClass highlight-line
            2024-04-16 17:32:10 DEBUG [CartObject/checkout] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/checkout
            2024-04-16 17:32:10 INFO  [CartObject/checkout] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:32:10 DEBUG [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:32:10 DEBUG [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): InvokeEntryMessage
            // withClass highlight-line
            2024-04-16 17:32:10 DEBUG [CheckoutService/handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CheckoutService/handle
            2024-04-16 17:32:10 INFO  [CheckoutService/handle] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:32:10 DEBUG [CheckoutService/handle][inv_12rkfeAcppNY3cI4F6DBZK8fir8uaIrIBP] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:32:11 DEBUG [CheckoutService/handle][inv_12rkfeAcppNY3cI4F6DBZK8fir8uaIrIBP] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): OutputEntryMessage
            2024-04-16 17:32:11 INFO  [CheckoutService/handle][inv_12rkfeAcppNY3cI4F6DBZK8fir8uaIrIBP] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:32:11 DEBUG [CheckoutService/handle][inv_12rkfeAcppNY3cI4F6DBZK8fir8uaIrIBP] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:32:11 INFO  [CheckoutService/handle][inv_12rkfeAcppNY3cI4F6DBZK8fir8uaIrIBP] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:32:11 DEBUG [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [2](): OutputEntryMessage
            2024-04-16 17:32:11 INFO  [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:32:11 DEBUG [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:32:11 INFO  [CartObject/checkout][inv_1aiqX0vFEFNH7u1kZjvyH4KJpuO9j4njCp] dev.restate.sdk.core.InvocationStateMachine - End invocation
            ```

        </TabItem>
    </Tabs>

</details>

## Durable Execution

The calls we just did seem like regular RPC calls as you might know them from other service frameworks.
But under the hood a lot more is happening.

Restate makes RPC calls resilient by letting the Restate Server and SDK cooperate.
Restate tracks the execution of code in a journal and can replay it in case of a failure.
This is called **Durable Execution.**

Have a look at the animation to understand what happened under-the-hood:

<TourAnimation/>

Whenever a failure would happen, Restate would be able to recover the latest state of the handler by sending over the journal.
The code would fast-forward to the point where it crashed, and continue executing from there on.

To see the recovery of partial progress in practice, let's make the `CartObject/addTicket` handler crash right after the call.

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        <CH.Code lineNumbers={true}>
        ```typescript cart_object.ts
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part1/cart_object.ts#<start_add_ticket>-<end_add_ticket>
        ```
        </CH.Code>

        Add the following code to line 4 of the snippet, to let the code throw an error after the call:
        ```typescript
        throw new Error("Failing");
        ```


        <details className={"grey-details"}>
            <summary>Service logs</summary>

            ```log
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.245Z] DEBUG:  Adding message to journal and sending to Restate ; InvokeEntryMessage
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.246Z] DEBUG:  Scheduling suspension in 30000 ms
            [restate] [TicketObject/reserve][inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1][2024-04-16T13:28:20.296Z] DEBUG:  Invoking function.
            [restate] [TicketObject/reserve][inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1][2024-04-16T13:28:20.296Z] DEBUG:  Journaled and sent output message ; OutputEntryMessage
            // withClass highlight-line
            [restate] [TicketObject/reserve][inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1][2024-04-16T13:28:20.296Z] DEBUG:  Function completed successfully.
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.362Z] DEBUG:  Received completion message from Restate, adding to journal.
            // withClass highlight-line ; CompletionMessage
            Trace: [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.363Z] TRACE:  Function completed with an error: Failing Error: Failing
            ... rest of trace ...
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.372Z] DEBUG:  Invocation ended with retryable error. ; ErrorMessage
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.437Z] DEBUG:  Resuming (replaying) function.
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.437Z] DEBUG:  Matched and replayed message from journal ; InvokeEntryMessage
            // withClass highlight-line
            Trace: [restate] [CartObject/addTicket][inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5][2024-04-16T13:28:20.437Z] TRACE:  Function completed with an error: Failing Error: Failing
            ... rest of trace ...
            ```

        </details>


    </TabItem>
    <TabItem value="java" label="Java">

        <CH.Code lineNumbers={true}>
            ```java CartObject.java
            CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part1/CartObject.java#<start_add_ticket>-<end_add_ticket>
            ```
        </CH.Code>

        Instead of returning true, let the code fail after the call:

        ```java
        throw new IllegalStateException("The handler failed");
        ```

        <details className={"grey-details"}>
            <summary>Service logs</summary>

            ```log
            // withClass highlight-line
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/addTicket
            2024-04-16 17:33:59 INFO  [CartObject/addTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): InvokeEntryMessage
            // withClass highlight-line
            2024-04-16 17:33:59 DEBUG [TicketObject/reserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to TicketObject/reserve
            2024-04-16 17:33:59 INFO  [TicketObject/reserve] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:33:59 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz6Dn3DPBWPXOWCarIhmgCSl] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-16 17:33:59 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz6Dn3DPBWPXOWCarIhmgCSl] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): OutputEntryMessage
            2024-04-16 17:33:59 INFO  [TicketObject/reserve][inv_1aAMfXkieWDz6Dn3DPBWPXOWCarIhmgCSl] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-16 17:33:59 DEBUG [TicketObject/reserve][inv_1aAMfXkieWDz6Dn3DPBWPXOWCarIhmgCSl] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:33:59 INFO  [TicketObject/reserve][inv_1aAMfXkieWDz6Dn3DPBWPXOWCarIhmgCSl] dev.restate.sdk.core.InvocationStateMachine - End invocation
            // withClass highlight-line
            2024-04-16 17:33:59 WARN  [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Error when processing the invocation
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            2024-04-16 17:33:59 WARN  [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Invocation failed
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-16 17:33:59 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - End invocation
            // withClass highlight-line
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/addTicket
            2024-04-16 17:33:59 INFO  [CartObject/addTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-16 17:33:59 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            // withClass highlight-line
            2024-04-16 17:33:59 WARN  [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Error when processing the invocation
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            2024-04-16 17:33:59 WARN  [CartObject/addTicket][inv_1aiqX0vFEFNH5uLBb8M6CjbRkVUcVScH1T] dev.restate.sdk.core.InvocationStateMachine - Invocation failed
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            ```

        </details>
    </TabItem>
</Tabs>

Call `CartObject/addTicket` again and have a look at the service logs.
You see the retries taking place. And you see that only the first time the call to the `CheckoutService` was made.
The other times, the call was skipped and the journaled response was replayed.

[By default](/operate/configuration#default-configuration), Restate will keep retrying failed invocations until they succeed.
If you want to cancel an invocation in a retry loop, you can use the CLI to do this. Let's have a look at that next.

## Debugging with the CLI

Now that we have a failing invocation, let's take the opportunity to show you how you can get more information about what is going on with the CLI.
The CLI is a management tool that lets you interact with the Restate Server.
You can use it to boostrap a new project, but also to get information about the services and invocations.

Have a look at some useful commands and try them out yourself:

<CliAnimation listOfSteps={[`$ restate services list
NAME             REVISION  FLAVOR  DEPLOYMENT TYPE  DEPLOYMENT ID
üåé  TicketObject     1                 HTTP 2           dp_14LsPzGz9HBxXIeBoH5wYUh
üåé  CartObject       1                 HTTP 2           dp_14LsPzGz9HBxXIeBoH5wYUh
üåé  CheckoutService  1                 HTTP 2           dp_14LsPzGz9HBxXIeBoH5wYUh`,
`$ restate services describe CartObject
üìú Component Information:
‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
Name:                    CartObject
Flavor (Instance Type):  Service
Revision:                1
Public:                  true
Deployment ID:           dp_14LsPzGz9HBxXIeBoH5wYUh
Deployment Type:         HTTP 2
Protocol Style:          Streaming
Endpoint:                http://host.docker.internal:9080/
Created at:              2024-04-12T13:00:03.522000000Z


üîå Methods:
‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
METHOD        INPUT TYPE                                   OUTPUT TYPE
expireTicket  one of "empty or value of content-type */*"  value with content-type "application/json"
checkout      one of "empty or value of content-type */*"  value with content-type "application/json"
addTicket     one of "empty or value of content-type */*"  value with content-type "application/json"`,
`$ restate invocations list
  ‚ùØ [2024-04-16 15:28:20.237 +02:00] inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5 [CartObject @ Mary]::addTicket
     Status:      backing-off  (4 minutes, 42 seconds and 653 ms. Retried 32 time(s). Next
                  retry in in 9 seconds and 469 ms))
     Deployment:  dp_14LsPzGz9HBxXIeBoH5wYUh [required]
     Error:       [2024-04-16 15:33:01.930 +02:00]
                  [500] Failing

Showing 1/1 invocations. Query took 86.295361ms
`,
`$ restate invocations describe inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1
üìú Invocation Information:
‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
 Created at:   2024-04-16 15:28:20.237 +02:00 (5 minutes ago)
 Component:    CartObject @ Mary
 Method:       addTicket
 Status:       backing-off  (5 minutes, 49 seconds and 253 ms. Retried 37 time(s). Next retry in in 508 ms))
 Deployment:   dp_14LsPzGz9HBxXIeBoH5wYUh [required]
 Error:        [2024-04-16 15:33:58.918 +02:00]
               [500] Failing
 Modified at:  2024-04-16 15:28:20.278 +02:00

  üí°   This invocation is bound to run on deployment 'dp_14LsPzGz9HBxXIeBoH5wYUh'. To guarantee
       safety and correctness, invocations that made progress on a deployment
       cannot move to newer deployments automatically.

üöÇ Invocation Progress:
‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï
[Ingress]
 ‚îî‚îÄ‚îÄ(this)‚îÄ> [CartObject @ Mary]::addTicket
     ‚ñ∏
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ ‚òëÔ∏è  #1 Invoke TicketObject::reserve inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ>> backing-off`,
`$ restate invocations cancel inv_1iGFK6hGrtOf3jcD8PupmCOJz1SDzvfPi1
  ‚ùØ [2024-04-16 15:28:20.237 +02:00] inv_1aiqX0vFEFNH0TF1pLRFBDFosQCCTAN1M5 [CartObject @ Mary]::addTicket
     Status:      backing-off  (7 minutes, 9 seconds and 590 ms. Retried 44 time(s). Next retry in in 3 seconds
                  and 673 ms))
     Deployment:  dp_14LsPzGz9HBxXIeBoH5wYUh [required]
     Error:       [2024-04-16 15:35:21.462 +02:00]
                  [500] Failing

‚úî Are you sure you want to cancel this invocation ¬∑ yes

‚úÖ Request was sent successfully`]}
/>

<Admonition type="note">
Remove the throwing of the exception from your code before you continue.
</Admonition>

<Admonition type="info">
üö© Explore the intermediate solution in `part1`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part1
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part1.AppMain run
```

</TabItem>
</Tabs>
</Admonition>

## Scheduling Async Tasks

<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part2"/>

When a handler calls another handler, Restate registers the call and makes sure it happens.
You can also ask Restate to execute the call at a later point in the future, by adding a delay parameter to the call.
Restate then registers the call and triggers it after the delay has passed.

In the application, a ticket gets reserved for 15 minutes.
If the user doesn't pay within that time interval, then it becomes available again to other users.
Let the `CartObject/addTicket` handler call the `CartObject/expireTicket` handler with a delay of 15 minutes:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript cart_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part2/cart_object.ts#<start_add_ticket>-<end_add_ticket>
```

</TabItem>
<TabItem value="java" label="Java">

```java CartObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part2/CartObject.java#<start_add_ticket>-<end_add_ticket>
```

</TabItem>
</Tabs>


To test it out, put the delay to a lower value, for example 5 seconds, call the `addTicket` function, and see in the logs how the call to `CartObject/expireTicket` is executed 5 seconds later.
<details className="grey-details">
    <summary>Service logs</summary>
    <Tabs groupId="sdk" queryString className={"display-none"}>
        <TabItem value="ts" label="TypeScript">

            ```log
            ... logs from reserve call ...
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Received completion message from Restate, adding to journal. ; CompletionMessage
            // withClass highlight-line
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            [restate] [CartObject/addTicket][inv_1gdJBtdVEcM90xbqbDEnOzNgilf2WmjZTP][2024-03-19T08:49:43.081Z] DEBUG: Function completed successfully.
            [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.092Z] DEBUG: Invoking function.
            [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Adding message to journal and sending to Restate ; BackgroundInvokeEntryMessage
            [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            [restate] [CartObject/expireTicket][inv_1gdJBtdVEcM93r8tce9IfwnbiAsk8lCevD][2024-03-19T08:49:48.093Z] DEBUG: Function completed successfully.
            // withClass highlight-line
            [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Invoking function.
            [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Journaled and sent output message ; OutputStreamEntryMessage
            [restate] [TicketObject/unreserve][inv_1k78Krj3GqrK529L4BRmz8ntFtiw2DkahH][2024-03-19T08:49:48.141Z] DEBUG: Function completed successfully.
            ```

        </TabItem>
        <TabItem value="java" label="Java">

            ```log
            ... logs from reserve call ...
            2024-04-17 08:08:10 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH3fRqvARAGmeIcbyLXImG3L] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            // withClass highlight-line
            2024-04-17 08:08:10 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH3fRqvARAGmeIcbyLXImG3L] dev.restate.sdk.core.InvocationStateMachine - End invocation
            // withClass highlight-line
            2024-04-17 08:08:15 DEBUG [CartObject/expireTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/expireTicket
            2024-04-17 08:08:15 INFO  [CartObject/expireTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-17 08:08:15 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-17 08:08:15 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): BackgroundInvokeEntryMessage
            2024-04-17 08:08:15 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [2](): OutputEntryMessage
            2024-04-17 08:08:15 INFO  [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-17 08:08:15 DEBUG [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-17 08:08:15 INFO  [CartObject/expireTicket][inv_1aiqX0vFEFNH5R28lg9wg1c3CtOJOhHEM9] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-17 08:08:15 DEBUG [TicketObject/unreserve] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to TicketObject/unreserve
            2024-04-17 08:08:15 INFO  [TicketObject/unreserve] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-17 08:08:15 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz0btTCuaF2NHgJEdX2tXHCF] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            2024-04-17 08:08:15 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz0btTCuaF2NHgJEdX2tXHCF] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): OutputEntryMessage
            2024-04-17 08:08:15 INFO  [TicketObject/unreserve][inv_1aAMfXkieWDz0btTCuaF2NHgJEdX2tXHCF] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-17 08:08:15 DEBUG [TicketObject/unreserve][inv_1aAMfXkieWDz0btTCuaF2NHgJEdX2tXHCF] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-17 08:08:15 INFO  [TicketObject/unreserve][inv_1aAMfXkieWDz0btTCuaF2NHgJEdX2tXHCF] dev.restate.sdk.core.InvocationStateMachine - End invocation
            ```

        </TabItem>
    </Tabs>
</details>
Don't forget to set the delay back to 15 minutes.

<Admonition type="tip" title={"No workflow orchestrator or cron jobs needed!"}>
Durable timers are a powerful feature that can be used to implement workflows, schedule async tasks, or plan background jobs.
Restate makes them resilient to failures and ensures that they get executed. No extra infrastructure needed!
</Admonition>

<Admonition type="info" title="Suspendable sleep">
Another timer-like feature of the SDK is suspendable sleep.
Restate will make sure that the function gets resumed after the specified duration has passed.
When running on function-as-a-service platforms, your function can suspend in the meantime, so you don't pay for the wait time.
<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```ts
        CODE_LOAD::ts/src/get_started/tour.ts#<start_sleep>-<end_sleep>
        ```

    </TabItem>
    <TabItem value="java" label="Java">

        ```java
        CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_sleep>-<end_sleep>
        ```

    </TabItem>
</Tabs>

</Admonition>


<Admonition type="info">
üö© Explore the intermediate solution in `part2`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part2
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part2.AppMain run
```

</TabItem>
</Tabs>
</Admonition>


## Virtual Objects vs. Services
<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part3"/>

At the beginning of this tutorial, we mentioned that the `TicketObject` and `CartObject` services are Virtual Objects.

**Virtual Objects** are identified by a key and allow you to store K/V state in Restate.
For each Virtual Object, only one invocation can run at a time (across all the handlers of that Virtual Object).

**Services**, on the other hand, do not have access to K/V state, and handlers can run concurrently.

<Admonition type={"tip"} title={"Virtual Objects simplify many use cases"}>
With access to consistent K/V state and strong concurrency guarantees, implementing the `TicketObject` in a resilient and consistent way becomes straightforward.
When a user reserves a ticket, we want to be sure that no concurrent other requests are reserving the same ticket at the same time.
To get this behaviour, we key the `TicketObject` on ticket ID. We now have a single Virtual Object per ticket.
</Admonition>

<Admonition type="caution" title={"Long-running operations in Virtual Objects"}>
    If you do long-running operations in a Virtual Object, no other invocations are processed the meantime.
    For example, if you would implement the expiration of the ticket in the `CartObject` service by sleeping for 15 minutes:

    <Tabs groupId="sdk" queryString className={"display-none"}>
        <TabItem value="ts" label="TypeScript">

            ```typescript
            CODE_LOAD::ts/src/get_started/tour.ts#<start_sleep_and_send>-<end_sleep_and_send>
            ```

        </TabItem>
        <TabItem value="java" label="Java">

            ```java
            CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_sleep_and_send>-<end_sleep_and_send>
            ```

        </TabItem>
    </Tabs>
    The user wouldn't be able to add any other tickets, nor buy the tickets.
    If you do a delayed call, the invocation isn't ongoing until the delay has passed, so the Virtual Object is not locked.
</Admonition>

## Consistent K/V state

Restate offers a key-value store to store application state for Virtual Objects.

<Admonition type="tip" title="No need for session databases!">
Restate's state is guaranteed to be consistent across retries and invocations.
This eliminates the need for a session database.
</Admonition>

### Getting and setting K/V state

Adapt the `CartObject/addTicket` function to keep track of the cart items.
After reserving the product, you add the ticket to the shopping cart.
Have a look at the highlighted code:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts cart_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/cart_object.ts#<start_add_ticket>-<end_add_ticket>
```

To retrieve the cart, you use `ctx.get`.
This returns `null` if the value has never been set.

</TabItem>
<TabItem value="java" label="Java">

```java CartObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_add_ticket>-<end_add_ticket>
```

To retrieve the cart, you use `ctx.get` with a state key that describes the name and the [(de)serializers](/develop/java/serialization) to be used.
    `ctx.get` returns an Optional, only containing a value if one was set before.

</TabItem>
</Tabs>

After you added the ticket to the cart array, you set the state to the new value with `ctx.set`.

You can store multiple key-value pairs, by using different state keys.
Here, you get the value under the key `"tickets"`.
Restate returns the cart belonging to the current Virtual Object (for example, user `Mary`).

Run the services and call the `addTicket` function, to see the interaction with state.

<details className="grey-details">
<summary>Service logs</summary>
<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```log
... logs from reserve call ...
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM97yGYEG5NWYtbMlnSAGHGY9][2024-03-19T08:55:20.941Z] DEBUG: Adding message to journal and sending to Restate ; GetStateEntryMessage
// withClass highlight-line
[restate] [CartObject/addTicket][inv_1gdJBtdVEcM97yGYEG5NWYtbMlnSAGHGY9][2024-03-19T08:55:20.941Z] DEBUG: Adding message to journal and sending to Restate ; SetStateEntryMessage
... logs from expireTicket call ...
```

</TabItem>
<TabItem value="java" label="Java">

```log

... reserve call ...
2024-04-17 08:13:23 DEBUG [CartObject/addTicket] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CartObject/addTicket
2024-04-17 08:13:23 INFO  [CartObject/addTicket] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [1](): InvokeEntryMessage
// withClass highlight-line
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [2](): GetStateEntryMessage
// withClass highlight-line
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [3](): SetStateEntryMessage
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [4](): BackgroundInvokeEntryMessage
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Current journal entry [5](): OutputEntryMessage
2024-04-17 08:13:23 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - End invocation
2024-04-17 08:13:23 DEBUG [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
2024-04-17 08:13:23 INFO  [CartObject/addTicket][inv_1aiqX0vFEFNH7nJWPQ0NFyGKHOyNmoE3hn] dev.restate.sdk.core.InvocationStateMachine - End invocation
```

</TabItem>
</Tabs>

</details>

<Admonition type="tip" title="Local state access">
When starting the invocation, Restate attaches the application state to the request.
So when you operate on the state in your function with `ctx.get` and `ctx.set`, you get access to a local copy of the state for fast access.
</Admonition>

Also adapt the `CartObject/checkout` function, to use the tickets:

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```typescript cart_object.ts
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/cart_object.ts#<start_checkout>-<end_checkout>
        ```

    </TabItem>
    <TabItem value="java" label="Java">

        ```java CartObject.java
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_checkout>-<end_checkout>
        ```

    </TabItem>
</Tabs>

After the tickets are checked out, you clear the state with `ctx.clear`.

### Inspecting K/V state

Restate exposes information on invocations and application state.
You can watch the state of the `CartObject` service, via:

<CH.Code>

    ```shell CLI
    restate kv get -w -n 1 CartObject Mary
    ```

    ```shell psql
    watch -n 1 'psql -h localhost -p 9071 -c "SELECT * FROM state WHERE component like '\''%CartObject%'\''";'
    ```
</CH.Code>

<details className="grey-details">
    <summary>Output</summary>

    ```json
    ü§ñ State:
    ‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï

    Component  CartObject
    Key        Mary

    KEY      VALUE
    tickets  [
        "seat2B"
    ]
    ```

</details>

Add some tickets to the state to see how the query result gets updated.

Then, send a checkout request as [earlier](#request-response-calls-over-http), and notice that the state is now empty.


### üìù Try it out

#### Finishing `CartObject/expireTicket`

You have almost fully implemented the `CartObject`. Let's finish `CartObject/expireTicket`.

Before you call `unreserve`, you first need to check if the ticket is still held by the user.
Retrieve the state and check if the ticket ID is in there.
If this is the case, then you call `TicketObject/unreserve` and remove it from the state.

<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts cart_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/cart_object.ts#<start_expire_ticket>-<end_expire_ticket>
```

</TabItem>
<TabItem value="java" label="Java">

```java CartObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/CartObject.java#<start_expire_ticket>-<end_expire_ticket>
```

</TabItem>
</Tabs>

Call the `expireTicket` handler with:
```shell
curl localhost:8080/CartObject/Mary/expireTicket -H 'content-type: application/json' -d '"seat2B"'
```

</details>

#### Implementing the `TicketObject`

Track the status of the tickets in the `TicketObject` by storing it in the state.
Implement the handlers in the `TicketObject` to reserve, unreserve, and mark a ticket as sold.

While you are developing them, you can use psql to monitor the state of the `TicketObject`:

<CH.Code>

    ```shell CLI
    restate kv get -w -n 1 TicketObject seat2B
    ```

    ```shell psql
    watch -n 1 'psql -h localhost -p 9071 -c "select * from state where component like '\''%TicketObject%'\''";'
    ```
</CH.Code>

<SubtleStep title="TicketObject/reserve" stepLabel="1">
1. Retrieve the value for the `"status"` state key.
2. If the value is set to `TicketStatus.Available`, then change it to `TicketStatus.Reserved` and
return `true` (reservation successful).
3. If the status isn't set to `TicketStatus.Available`, then return `false`.

<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript ticket_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/ticket_object.ts#<start_reserve>-<end_reserve>
```

</TabItem>
<TabItem value="java" label="Java">

```java TicketObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_reserve>-<end_reserve>
```

</TabItem>
</Tabs>

Now, you can't reserve the same ticket multiple times anymore.
Call `addTicket` multiple times for the same ID. The first time it returns `true`, afterwards `false`.
</details>

</SubtleStep>

<SubtleStep stepLabel="2" title="TicketObject/unreserve">
Clear the `"status"`, if it's not equal to `TicketStatus.Sold`.
<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts ticket_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/ticket_object.ts#<start_unreserve>-<end_unreserve>
```

</TabItem>
<TabItem value="java" label="Java">

```java TicketObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_unreserve>-<end_unreserve>
```
</TabItem>
</Tabs>

Now, the ticket reservation status is cleared when the delayed `expireTicket` call triggers.
Play around with reducing the delay of the `expireTicket` call in the `addTicket` handler.
Try to reserve the same ticket ID multiple times, and see how you are able to reserve it again after the `unreserve` handler executed.

</details>
</SubtleStep>
<SubtleStep stepLabel="3" title="TicketObject/markAsSold">
Set the `"status"` to `TicketStatus.Sold` if it's reserved.

<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts ticket_object.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part3/ticket_object.ts#<start_mark_as_sold>-<end_mark_as_sold>
```

</TabItem>
<TabItem value="java" label="Java">

```java TicketObject.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part3/TicketObject.java#<start_mark_as_sold>-<end_mark_as_sold>
```
</TabItem>
</Tabs>

In the next section, you implement the `CheckoutService/handle` function that calls `markAsSold`.
This ties the final parts together.
</details>
</SubtleStep>

<Admonition type="info">
üö© Explore the intermediate solution in `part3`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part3
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part3.AppMain run
```

</TabItem>
</Tabs>
</Admonition>


## Storing results in the journal

<Admonition type="note" title="Implement it yourself or follow along by looking at the code under part4"/>

Restate's Durable Execution mechanism tracks the progress of the code execution in a journal.
Once a result has made it to the journal, it will not be re-executed on retries.

You can store the return value of any function in the journal, by using `ctx.run`.
This lets you capture potentially non-deterministic computation and interaction with external systems in a safe way.
The SDK also offers helper functions for creating UUIDs and generating random numbers.

<Admonition type="info" title="Handler logic needs to be deterministic">
For the replay to work, code needs to be deterministic, otherwise the replayed entries do not line up with the code execution on retries.
So use `ctx.run` to store the result of non-deterministic operations!
</Admonition>

We can use this feature to do exactly-once payments in `CheckoutService/handle`:

<SubtleStep stepLabel="1" title="Generate an idempotency token">
Let's use the SDK helper functions to generate a unique payment identifier and store it in Restate.
Once the token is stored, it will be the same on retries.
Try it out by printing the idempotency key and then throwing an error:

<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```ts checkout_service.ts
        CODE_LOAD::ts/src/get_started/tour.ts#<start_uuid>-<end_uuid>
        ```

    </TabItem>
    <TabItem value="java" label="Java">

        ```java CheckoutService.java
        CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_uuid>-<end_uuid>
        ```

    </TabItem>
</Tabs>
<details className="grey-details">
    <summary>Service logs</summary>

    <Tabs groupId="sdk" queryString className={"display-none"}>
        <TabItem value="ts" label="TypeScript">

            ```log
            ... logs of `CartObjectService/CheckoutService` ...
            [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.498Z] DEBUG: Invoking function.
            // withClass highlight-line
            My idempotency key: e25b747f-ecfb-443b-8939-1935392aab6b
            Trace: [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.499Z] TRACE: Function completed with an error: Something happened! Error: Something happened!
            ... rest of trace  ...
            [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.512Z] DEBUG: Invocation ended with retryable error. ; ErrorMessage
            [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] DEBUG: Invoking function.
            // withClass highlight-line
            My idempotency key: e25b747f-ecfb-443b-8939-1935392aab6b
            Trace: [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] TRACE: Function completed with an error: Something happened! Error: Something happened!
            ... rest of trace  ...
            [restate] [CheckoutService/handle][inv_1jhuapyO2Bpg3prqzrAJOFs99mt7jv5x3r][2024-03-19T09:15:30.568Z] DEBUG: Invocation ended with retryable error. ; ErrorMessage
            ... retries continue ...
            ```

        </TabItem>
        <TabItem value="java" label="Java">

            ```log
            2024-04-17 08:33:52 DEBUG [CheckoutService/handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CheckoutService/handle
            2024-04-17 08:33:52 INFO  [CheckoutService/handle] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            2024-04-17 08:33:52 DEBUG [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            // withClass highlight-line
            My idempotency key: e43f57b8-ab19-27f2-3693-2e7dd6bda399
            2024-04-17 08:33:52 WARN  [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Error when processing the invocation
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            2024-04-17 08:33:52 DEBUG [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to CLOSED
            2024-04-17 08:33:52 INFO  [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.InvocationStateMachine - End invocation
            2024-04-17 08:33:52 DEBUG [CheckoutService/handle] dev.restate.sdk.http.vertx.RequestHttpServerHandler - Handling request to CheckoutService/handle
            2024-04-17 08:33:52 INFO  [CheckoutService/handle] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Start processing invocation
            // withClass highlight-line
            2024-04-17 08:33:52 DEBUG [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.InvocationStateMachine - Transitioning state machine to REPLAYING
            // withClass highlight-line
            My idempotency key: e43f57b8-ab19-27f2-3693-2e7dd6bda399
            2024-04-17 08:33:52 WARN  [CheckoutService/handle][inv_155UJNoky4WU38J6ReFTcsOP0S1XiFjWWl] dev.restate.sdk.core.ResolvedEndpointHandlerImpl - Error when processing the invocation
            java.lang.IllegalStateException: The handler failed
            ... rest of trace ...
            ```

        </TabItem>
    </Tabs>

</details>

Call `CartObject/checkout` and have a look at the logs to see what happens.
</SubtleStep>

<SubtleStep stepLabel="2" title="Trigger the payment">
Execute the payment via an external payment provider via `PaymentClient.get().call(idempotencyKey, amount)`.
The payment provider will deduplicate payments based on the idempotency token.
We assume every ticket costs 40 dollars.

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```typescript checkout_service.ts
CODE_LOAD::ts/src/get_started/tour.ts#<start_checkout>-<end_checkout>
```

</TabItem>
<TabItem value="java" label="Java">

```java CheckoutService.java
CODE_LOAD::java/src/main/java/get_started/Tour.java#<start_checkout>-<end_checkout>
```

</TabItem>
</Tabs>

</SubtleStep>

### üìù Try it out

Let's finish the checkout flow by sending the email notifications and marking the tickets as sold.

<SubtleStep stepLabel="1" title="Implement the email notifications">
After the `CheckoutService/handle` handler has handled the payment, you need to notify the users of the payment status:
- **Payment success**: notify the users via `EmailClient.get().notifyUserOfPaymentSuccess(request.getUserId())`.
- **Payment failure**: notify the users via the `EmailClient.get().notifyUserOfPaymentFailure(request.getUserId())`.

<details>
<summary>Solution</summary>

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```ts checkout_service.ts
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part4/checkout_service.ts#<start_checkout>-<end_checkout>
```

</TabItem>
<TabItem value="java" label="Java">

```java CheckoutService.java
CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part4/CheckoutService.java#<start_checkout>-<end_checkout>
```

</TabItem>
</Tabs>

</details>
</SubtleStep>

<SubtleStep stepLabel="2" title="Mark tickets as sold">
Let the `CartObject/checkout` handler mark all tickets as sold by calling `TicketObject/markAsSold` for each ticket.

<details>
<summary>Solution</summary>
<Tabs groupId="sdk" queryString className={"display-none"}>
    <TabItem value="ts" label="TypeScript">

        ```typescript cart_object.ts
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-typescript/src/part4/cart_object.ts#<start_checkout>-<end_checkout>
        ```

    </TabItem>
    <TabItem value="java" label="Java">

        ```java CartObject.java
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/dev_0.9/tutorials/tour-of-restate-java/src/main/java/dev/restate/tour/part4/CartObject.java#<start_checkout>-<end_checkout>
        ```

    </TabItem>
</Tabs>
</details>

</SubtleStep>

ü•≥ You have now fully implemented the ticket reservation system!
Try it out by reserving some new tickets and buying them by checking out the cart.

<Admonition type="info">
üö© Explore the intermediate solution in `part4`, and run it with:

<Tabs groupId="sdk" queryString className={"display-none"}>
<TabItem value="ts" label="TypeScript">

```shell
npm run part4
```

</TabItem>
<TabItem value="java" label="Java">

```shell
./gradlew -PmainClass=dev.restate.tour.part4.AppMain run
```

</TabItem>
</Tabs>
</Admonition>



## Tracing
Restate exposes OpenTelemetry traces of your invocations.

<SubtleStep stepLabel="1" title="Run Jaeger">

```shell
docker run -d --name jaeger -e COLLECTOR_OTLP_ENABLED=true \
    -p 4317:4317 -p 16686:16686 jaegertracing/all-in-one:1.46
```
</SubtleStep>
<SubtleStep stepLabel="2" title="Relaunch Restate with tracing enabled">
```shell
docker run --name restate_dev -p 8080:8080 -p 9070:9070 -p 9071:9071 \
    -e RESTATE_OBSERVABILITY__TRACING__ENDPOINT=http://host.docker.internal:4317 \
    --add-host=host.docker.internal:host-gateway docker.io/restatedev/restate:VAR::RESTATE_VERSION
```
</SubtleStep>
<SubtleStep stepLabel="3" title="Register the service and send a few requests">
    <CH.Code rows={"4"}>

        ```shell CLI
        restate deployments register http://localhost:9080
        curl localhost:8080/CartObject/Mary/addTicket -H 'content-type: application/json' -d '"seat2B"'
        curl -X POST localhost:8080/CartObject/Mary/checkout
        ```

        ```shell curl
        curl localhost:9070/deployments -H 'content-type: application/json' \
            -d '{"uri": "http://localhost:9080"}'
        curl localhost:8080/CartObject/Mary/addTicket -H 'content-type: application/json' -d '"seat2B"'
        curl -X POST localhost:8080/CartObject/Mary/checkout
        ```

    </CH.Code>

</SubtleStep>
<SubtleStep stepLabel="4" title="Go to the Jaeger UI">
http://localhost:16686
</SubtleStep>
<SubtleStep stepLabel="5" title="Inspect the traces">

Select the `CartObject` service from the service dropdown.
You should see the `addTicket` and `checkout` requests listed.
Have a look at the traces of the `checkout` call:

![CheckoutService call traces](/img/jaeger_checkout_traces_tour_handler.png)

You can see the calls that were done to Restate, for example invoke, sleep, one way call, get state, etc., and their timings.
If you expand one of the traces, you can see tags describing some metadata of the context call, for example invocation ID and the request.
</SubtleStep>
For more information, have a look at the [tracing docs](/operate/monitoring/tracing).

## üèÅ The end
You reached the end of this tutorial!

Let's recap what you did! You have built a ticket reservation system that is resilient, consistent, and scalable.
We used Restate to provide us with durable, distributed building blocks to simplify the implementation of the system.
Let's list a few of them:

| What you implemented                                        | What you didn't implement, as Restate handles it for you                                       |
|--------------------------------------------------------------|------------------------------------------------------------------------------------------------|
| ‚úÖ Request-response invocations                               | ‚ùå Handling retries, timeouts, etc.                                                            |
| ‚úÖ Sending messages                                           | ‚ùå Deploy and operate message queues for async requests                                        |
| ‚úÖ Durable Execution: retries, partial progress recovery, and suspensions | ‚ùå Manual retry logic and partial progress recovery                                 |
| ‚úÖ Durable timers: sleeping and scheduling async tasks         | ‚ùå Workflow orchestrators or cron jobs for scheduling tasks                                     |
| ‚úÖ Virtual Objects: concurrency guarantees and shared state    | ‚ùå Guards for keeping state consistent across retries, concurrent requests, and scaling out.    |
| ‚úÖ K/V state: storing and inspecting                          | ‚ùå Session databases for state. State consistency guards.                                       |
| ‚úÖ Storing computation results in the journal                 | ‚ùå Logic to make operations idempotent (e.g. generate idempotency keys)                         |

You now know the essentials to start developing Restate services! Have a look at the next steps to explore further.

## Next steps
- [Run the examples](https://github.com/restatedev/examples)
- [Read the Concepts](/concepts/durable_building_blocks): although most of this has been covered in this tutorial
- [Check out the Java SDK documentation](/category/javakotlin-sdk)
- [Check out the TypeScript SDK documentation](/category/typescript-sdk)




