---
title: "Sagas"
description: "Implementing undo operations in case of failures, to keep your system consistent"
pagination_next: null
pagination_prev: null
---

import Admonition from "@theme/Admonition";
import {Step} from "../../src/components/Stepper";
import {CodeWithTabs} from "../../src/components/code/code";

# Sagas

When building distributed systems, it is crucial to ensure that the system remains consistent even in the presence of failures.
One way to achieve this is by using the [Saga pattern](https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga).

<Admonition type={"tip"} title={"What is a Saga?"}>
Sagas are a way to manage transactions that span multiple services.
They allow you to run compensations when your code crashes halfway through.
This way, you can **ensure that your system remains consistent even in the presence of failures**.
</Admonition>


## How does Restate help?

Restate makes it easy to implement resilient sagas in your code:
- **Durable Execution**: Restate guarantees that your code runs to completion. If a failure occurs, Restate automatically retries from the point of failure and ensures that all compensations run.
- **Resilience built-in**: No need to manually track state or retry logic. Restate handles all persistence and compensation orchestration for you.
- **Code-first approach**: Define sagas using regular code, no DSLs. Track compensations in a list, and execute them on failure.

## Example

Here is a typical travel booking workflow, where you book a flight, then rent a car, and finally book a hotel.
If any step fails, we want to roll back the previous steps to keep the system consistent.

<img src={"/img/guides/sagas/saga_diagram.svg"} alt="Sagas example diagram" width={"550px"}/>

**Restate lets us implement this purely in code without any DSLs or extra infrastructure.**
- Wrap your business logic in a try-block, and throw a terminal error for cases where you want to compensate and finish.
- For each step you do in your try-block, add a compensation to a list.
- In the catch block, in case of a terminal error, you run the compensations in reverse order, and rethrow the error.

<CodeWithTabs groupId={"sdk"}>
        ```ts !!tabs TypeScript https://github.com/restatedev/examples/blob/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
        // collapse_prequel
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
        ```
        ```java !!tabs Java https://github.com/restatedev/examples/blob/main/java/patterns-use-cases/src/main/java/my/example/sagas/BookingWorkflow.java
        // collapse_prequel
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/updates_giselle/java/patterns-use-cases/src/main/java/my/example/sagas/BookingWorkflow.java
        ```
        ```kotlin !!tabs Kotlin https://github.com/restatedev/examples/blob/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
        // collapse_prequel
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
        ```
        ```python !!tabs Python https://github.com/restatedev/examples/blob/main/python/patterns-use-cases/sagas/app.py
        // collapse_prequel
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/python/patterns-use-cases/sagas/app.py
        ```
        ```go !!tabs Go https://github.com/restatedev/examples/blob/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
        // collapse_prequel
        CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
        ```
</CodeWithTabs>

<Admonition type={"note"} title={"Example not available in your language?"}>
    This pattern is implementable with any of our SDKs. We are still working on translating all patterns to all SDK languages.
    If you need help with a specific language, please reach out to us via [Discord](https://discord.com/invite/skW3AZ6uGd) or [Slack](https://join.slack.com/t/restatecommunity/shared_invite/zt-2v9gl005c-WBpr167o5XJZI1l7HWKImA).
</Admonition>

## When to use Sagas

It could seem that Durable Execution makes sagas less relevant.
Durable Execution tries to push execution forward and will retry invocations until they are completed.
On failures, the previous progress gets recovered and compensations don't need to run in between retries.

However, sagas remain essential in the following cases:

1. **Business logic requirements**: When your business logic demands to stop further execution (whenever you throw a [terminal error](/guides/error-handling#application-errors-terminal)), you can use a saga to ensure consistent rollback.
For example, if the hotel booking fails because the hotel is fully booked. Or if the car rental fails because the driving license country code is not accepted.

2. **When cancelling invocations**: On a [cancellation](/operate/invocation#cancelling-invocations) (via CLI/programmatically/UI), Restate will throw a terminal error in your handler.
If you have implemented a saga in your handler, then your system will gracefully roll back.
For example, if an invocation gets stuck because an external system is not responding, you might want to cancel the invocation while keeping the overall system state consistent.


## Registering compensations

Since sagas in Restate are implemented in user code, compensations are flexible and powerful, as long as they're idempotent.
You can reset service state, call other services to undo prior actions, use `ctx.run` to delete rows or reverse database operations.

Depending on the characteristics of the API, you might need to register compensations at different points in your code:

1. Two-step APIs: First you _reserve_, then _confirm_ or _cancel_. Register the compensation after reservation, when you have the resource ID.
Reservations that are not confirmed, get automatically cancelled by the API after a timeout.
<CodeWithTabs groupId={"sdk"}>
    ```ts !!tabs TypeScript https://github.com/restatedev/examples/blob/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
    ```
    ```java !!tabs Java
    CODE_LOAD::java/src/main/java/guides/sagas/BookingWorkflow.java#twostep
    ```
    ```kotlin !!tabs Kotlin https://github.com/restatedev/examples/blob/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
    ```
    ```python !!tabs Python https://github.com/restatedev/examples/blob/main/python/patterns-use-cases/sagas/app.py
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/python/patterns-use-cases/sagas/app.py
    ```
    ```go !!tabs Go https://github.com/restatedev/examples/blob/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
    ```
</CodeWithTabs>


2. One-shot APIs with idempotency key: First, you generate an idempotency key. Then, you register the compensation using the idempotency key. And finally, you call the API using the same idempotency key.
We need to register the compensation before calling the API, because there is a chance that the API call succeeded but that we never got the confirmation. So in this case, we need to roll back to a consistent state.

<CodeWithTabs groupId={"sdk"}>
    ```ts !!tabs TypeScript https://github.com/restatedev/examples/blob/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/typescript/patterns-use-cases/src/sagas/booking_workflow.ts
    ```
    ```java !!tabs Java
    CODE_LOAD::java/src/main/java/guides/sagas/BookingWorkflow.java#idempotency
    ```
    ```kotlin !!tabs Kotlin https://github.com/restatedev/examples/blob/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/kotlin/patterns-use-cases/src/main/kotlin/my/example/sagas/BookingWorkflow.kt
    ```
    ```python !!tabs Python https://github.com/restatedev/examples/blob/main/python/patterns-use-cases/sagas/app.py
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/python/patterns-use-cases/sagas/app.py
    ```
    ```go !!tabs Go https://github.com/restatedev/examples/blob/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
    // collapse_prequel
    CODE_LOAD::https://raw.githubusercontent.com/restatedev/examples/refs/heads/main/go/patterns-use-cases/src/sagas/bookingworkflow.go
    ```
</CodeWithTabs>
## Running the example

<Step stepLabel="1" title="Download the example">
    <CodeWithTabs groupId={"sdk"} className={"display-none"}>
        ```shell !!tabs ts
        restate example typescript-patterns-use-cases && cd typescript-patterns-use-cases
        ```
        ```shell !!tabs java
        restate example java-patterns-use-cases && cd java-patterns-use-cases
        ```
        ```shell !!tabs python
        restate example python-patterns-use-cases && cd python-patterns-use-cases
        ```
        ```shell !!tabs go
        restate example go-patterns-use-cases && cd go-patterns-use-cases
        ```
    </CodeWithTabs>
</Step>
<Step stepLabel="2" title="Start the Restate Server">
    ```shell
    restate-server
    ```
</Step>
<Step stepLabel="3" title="Start the Service">
    <CodeWithTabs groupId={"sdk"} className={"display-none"}>
        ```shell !!tabs ts
        npx tsx watch ./src/sagas/booking_workflow.ts
        ```
        ```shell !!tabs java
        ./gradlew -PmainClass=my.example.sagas.BookingWorkflow run
        ```
        ```shell !!tabs python
        python sagas/app.py
        ```
        ```shell !!tabs go
        go run ./src/sagas
        ```
    </CodeWithTabs>
</Step>
<Step stepLabel="4" title="Register the services">
    ```shell
    restate deployments register localhost:9080
    ```
</Step>
<Step stepLabel="5" title="Send a request">
    <CodeWithTabs groupId={"sdk"} className={"display-none"}>
        ```shell !!tabs ts
        curl localhost:8080/BookingWorkflow/run --json '{
                    "flights": {
                    "flightId": "12345",
                    "passengerName": "John Doe"
                },
                    "car": {
                    "pickupLocation": "Airport",
                    "rentalDate": "2024-12-16"
                },
                    "hotel": {
                    "arrivalDate": "2024-12-16",
                    "departureDate": "2024-12-20"
                }
            }'
        ```
        ```shell !!tabs java
        curl localhost:8080/BookingWorkflow/run --json '{
                    "flights": {
                    "flightId": "12345",
                    "passengerName": "John Doe"
                },
                    "car": {
                    "pickupLocation": "Airport",
                    "rentalDate": "2024-12-16"
                },
                    "hotel": {
                    "arrivalDate": "2024-12-16",
                    "departureDate": "2024-12-20"
                }
            }'
        ```
        ```shell !!tabs python
        curl localhost:8080/BookingWorkflow/run --json '{
                    "flights": {
                    "flightId": "12345",
                    "passengerName": "John Doe"
                },
                    "car": {
                    "pickupLocation": "Airport",
                    "rentalDate": "2024-12-16"
                },
                    "hotel": {
                    "arrivalDate": "2024-12-16",
                    "departureDate": "2024-12-20"
                }
            }'
        ```
        ```shell !!tabs go
        curl localhost:8080/BookingWorkflow/run --json '{
                    "flights": {
                    "flightId": "12345",
                    "passengerName": "John Doe"
                },
                    "car": {
                    "pickupLocation": "Airport",
                    "rentalDate": "2024-12-16"
                },
                    "hotel": {
                    "arrivalDate": "2024-12-16",
                    "departureDate": "2024-12-20"
                }
            }'
        ```
    </CodeWithTabs>

</Step>

<Step stepLabel="4" title="Check the UI or service logs">
    See how all tasks get spawned in parallel, finish at different times, and then get aggregated.

    <img src={"/img/guides/sagas/saga_journal.png"} alt="Sagas UI" />

    <CodeWithTabs groupId={"sdk"} className={"display-none"}>
        ```shell !!tabs ts

        ```
        ```shell !!tabs java
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run] dev.restate.sdk.core.statemachine.State - Start invocation
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.FlightClient - Flight reservation created with id: d643fa74-b265-49b1-9b65-3f75c4e10039
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.CarRentalClient - Car rental reservation created with id: 0ce92e7b-1d55-4c99-bbe3-1bb89695ccfd
        2025-05-29 11:08:09 ERROR [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.PaymentClient - [👻 SIMULATED] This credit card is not valid!
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.FlightClient - Flight reservation cancelled with id: d643fa74-b265-49b1-9b65-3f75c4e10039
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.CarRentalClient - Car rental reservation cancelled with id: 0ce92e7b-1d55-4c99-bbe3-1bb89695ccfd
        2025-05-29 11:08:09 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] my.example.sagas.clients.PaymentClient - Refunding payment with id: 93f00948-5c62-e7c8-a6e7-9c47df149bb2
        2025-05-29 11:08:20 WARN  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] dev.restate.sdk.core.RequestProcessorImpl - Error when processing the invocation
        dev.restate.sdk.common.TerminalException: [👻 SIMULATED] This credit card is not valid!
        ... rest of trace ...
        2025-05-29 11:08:20 INFO  [BookingWorkflow/run][inv_17GXsdM5pHmU2G6oBG6yNk9PyiEj67ZJMB] dev.restate.sdk.core.statemachine.State - Invocation ended
        ```
        ```shell !!tabs python

        ```
        ```shell !!tabs go

        ```
    </CodeWithTabs>
</Step>



## Related resources

- [Error Handling guide](/guides/error-handling)
- Terminal errors: [Java](/develop/java/error-handling) / [TS](/develop/ts/error-handling) / [Go](/develop/go/error-handling) / [Python](/develop/python/error-handling)  / [Rust](https://docs.rs/restate-sdk/latest/restate_sdk/errors/index.html)
- [Cancellation of invocations](/operate/invocation#cancelling-invocations)
- [Blog post: Graceful cancellations: How to keep your application and workflow state consistent 💪](https://restate.dev/blog/graceful-cancellations-how-to-keep-your-application-and-workflow-state-consistent/)
- [Microservice orchestration use case page](/use-cases/microservice-orchestration)
